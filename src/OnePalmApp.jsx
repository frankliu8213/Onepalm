import React, { useState, useEffect } from 'react';
import { Solar, Lunar } from 'lunar-javascript';
window.Solar = Solar;
window.Lunar = Lunar;
import { Book, Moon, Sun, RotateCcw, Info, Hand, Compass, Heart, Briefcase, AlertCircle, Sparkles, Star, GitMerge, MapPin, Scroll, User, Clock, Gem, Calendar, Users, Flower, CalendarCheck, ThumbsUp, Filter, Bot, MessageSquare, X, Printer, UserPlus, ArrowRightLeft, ShieldCheck, ShieldAlert } from 'lucide-react';

/**
 * è¾¾æ‘©ä¸€æŽŒç» (Dharma One Palm Sutra) Calculator
 * Combined Version with Relationship Module
 * Features:
 * - Core Destiny Calculation
 * - Birth Guide
 * - Relationship/Compatibility Analysis (New!)
 * - Print & AI Integration
 */

// --- Constants & Data ---

const REALMS = {
  BUDDHA: { name: 'ä½›é“', color: 'text-amber-700', bg: 'bg-amber-50', border: 'border-amber-200', icon: 'å', trait: 'æ…ˆæ‚²ä¸Žç¦æŠ¥' },
  IMMORTAL: { name: 'ä»™é“', color: 'text-sky-700', bg: 'bg-sky-50', border: 'border-sky-200', icon: 'â˜', trait: 'é€é¥ä¸Žæ™ºæ…§' },
  HUMAN: { name: 'äººé“', color: 'text-rose-700', bg: 'bg-rose-50', border: 'border-rose-200', icon: 'ì›ƒ', trait: 'å…¥ä¸–ä¸Žæƒè´£' },
  ASURA: { name: 'ä¿®ç½—', color: 'text-purple-700', bg: 'bg-purple-50', border: 'border-purple-200', icon: 'âš”', trait: 'å¥½èƒœä¸Žæ™ºè°‹' },
  GHOST: { name: 'é¬¼é“', color: 'text-slate-600', bg: 'bg-slate-100', border: 'border-slate-300', icon: 'ðŸ‘»', trait: 'åŒ®ä¹ä¸Žå¥”æ³¢' },
  ANIMAL: { name: 'ç•œé“', color: 'text-orange-700', bg: 'bg-orange-50', border: 'border-orange-200', icon: 'ðŸ¾', trait: 'æœ¬èƒ½ä¸ŽåŠ³ç¢Œ' },
  EMPTY: { name: '', color: '', bg: '', border: '', icon: '', trait: '' }
};

const STARS = {
  1: {
    id: 1, branch: 'å­', name: 'å¤©è´µæ˜Ÿ', realm: REALMS.BUDDHA,
    desc: 'ä½›é“å¤©è´µæ˜Ÿ', poem: 'æ—¶è¾°è½åœ¨å¤©è´µæ˜Ÿï¼Œä¸€ç”Ÿæ¸…è´µäº‹å’ŒåŒï¼Œå¿—æ°”ä¸å‡¡äººå‡ºç±»ï¼Œå®‰ç„¶è‡ªåœ¨æ€§æ˜Žé€šã€‚',
    archetype: 'æ¸…é«˜çš„æ™ºè€…',
    keywords: 'æ™ºæ…§ã€æ¸…é«˜ã€å­¤å‚²ã€æ…ˆæ‚²',
    general_analysis: 'å¤©è´µæ˜Ÿä»£è¡¨ç²¾ç¥žå±‚é¢çš„è´µæ°”ã€‚æ‚¨å¯èƒ½å¯¹ç‰©è´¨ç”Ÿæ´»çœ‹å¾—å¾ˆæ·¡ï¼Œä½†å¯¹ç²¾ç¥žè‡ªç”±è¦æ±‚å¾ˆé«˜ã€‚',
    gender_specific: {
      male: 'ç”·å‘½å¤©è´µï¼šå¤è¯€äº‘â€œä¸¤é‡å¤©è´µè€…è´µè€Œä¸è´µâ€ã€‚è‹¥å¤šè§ï¼Œåä¸»è™šåæ— å®žã€‚',
      female: 'å¥³å‘½å¤©è´µï¼šå¤è¯€äº‘â€œå¥³å‘½å¤©è´µé‡è€…ï¼Œç»ˆè®¸è§è´µâ€ã€‚ä¸»æ°”è´¨é«˜é›…ï¼Œæ™šè¿å®‰è¯¦ã€‚'
    },
    advice: 'é€‚åˆä»Žäº‹å­¦æœ¯ã€å“²å­¦æˆ–å®—æ•™ç ”ç©¶ã€‚éœ€è­¦æƒ•è¿‡äºŽæ¸…é«˜è€Œå¯¼è‡´çš„äººé™…å­¤ç«‹ã€‚',
    pos_meaning: {
      year: 'å¹´ä¸Šå¤©è´µï¼šä¸»ç¥–ä¸Šé˜´å¾·æ·±åŽšï¼Œå°‘å¹´æ—¶æœŸå¦‚é±¼å¾—æ°´ï¼Œå­¦ä¸šä¼˜ç§€ã€‚',
      month: 'æœˆä¸Šå¤©è´µï¼šé’å¹´æ—¶æœŸè´µäººè¿æžä½³ï¼Œäº‹ä¸šèµ·æ­¥é¡ºé£Žé¡ºæ°´ã€‚',
      day: 'æ—¥ä¸Šå¤©è´µï¼šä¸­å¹´è¿åŠ¿ç™»é¡¶ï¼Œå®¹æ˜“èŽ·å¾—ç¤¾ä¼šåœ°ä½ã€‚é…å¶è´¤è‰¯ã€‚',
      hour: 'æ—¶ä¸Šå¤©è´µï¼šæ™šå¹´å¾·é«˜æœ›é‡ï¼Œå­å¥³æˆæ‰ä¸”å­é¡ºã€‚'
    }
  },
  2: {
    id: 2, branch: 'ä¸‘', name: 'å¤©åŽ„æ˜Ÿ', realm: REALMS.GHOST,
    desc: 'é¬¼é“å¤©åŽ„æ˜Ÿ', poem: 'æ—¶åœ¨åŽ„ä¸­äººæ··æ²Œï¼Œæƒºæƒºä½œäº‹åˆç—´å‘†ï¼Œæ­¤äººå¸¦ç–¾æ–¹å»¶å¯¿ï¼Œè¿˜é¡»åŠ³ç¢Œä½œç”Ÿæ¶¯ã€‚',
    archetype: 'è´Ÿé‡çš„è¡Œè€…',
    keywords: 'ç£¨éš¾ã€æ·±é‚ƒã€ç„¦è™‘ã€æš—ç–¾',
    general_analysis: 'å¤©åŽ„å¹¶éžå•çº¯çš„ç¾éš¾ï¼Œæ›´å¤šæ˜¯ä¸€ç§â€œé˜»æ»žâ€æ„Ÿã€‚æ€æƒ³æ·±é‚ƒï¼Œä½†å®¹æ˜“æ€€æ‰ä¸é‡ã€‚',
    gender_specific: {
      male: 'ç”·å‘½å¤©åŽ„ï¼šä¸»è¦ä½“çŽ°ä¸ºäº‹ä¸šä¸Šçš„é˜»æ»žï¼Œæˆ–è€…èº«ä½“ä¸Šæœ‰æ…¢æ€§ç–¾ç—…ã€‚',
      female: 'å¥³å‘½å¤©åŽ„ï¼šå¤è¯€äº‘â€œå¥³æ€•ç ´åˆƒåŽ„â€ã€‚éœ€é˜²å¦‡ç§‘ç–¾åŽ„ï¼Œä¸»æ“å¿ƒåŠ³ç¢Œã€‚'
    },
    advice: 'é€‚åˆä»Žäº‹åŒ»ç–—ã€å¿ƒç†å’¨è¯¢ï¼ŒåŒ–è§£è‡ªèº«ä¸šåŠ›ã€‚å¤šå¸ƒæ–½å¯å‡è½»åŒ®ä¹æ„Ÿã€‚',
    pos_meaning: {
      year: 'å¹´ä¸Šå¤©åŽ„ï¼šç¥–ä¸šæ ¹åŸºè¾ƒå¼±ï¼Œæ—©å¹´ç”Ÿæ´»å¯èƒ½å……æ»¡æŒ‘æˆ˜ã€‚',
      month: 'æœˆä¸Šå¤©åŽ„ï¼šé’å¹´æ—¶æœŸäº‹ä¸šå‘å±•å®¹æ˜“ç¢°å£ï¼Œåªèƒ½é è‡ªå·±æ‰“æ‹¼ã€‚',
      day: 'æ—¥ä¸Šå¤©åŽ„ï¼šä¸­å¹´æ—¶æœŸéœ€ç‰¹åˆ«æ³¨æ„èº«ä½“å¥åº·ï¼Œå†…å¿ƒæ·±å¤„å¸¸æ„Ÿå­¤ç‹¬ã€‚',
      hour: 'æ—¶ä¸Šå¤©åŽ„ï¼šæ™šå¹´éœ€é˜²æ—§ç–¾å¤å‘ï¼Œå®œæ—©åšå¥åº·å’Œå…»è€è§„åˆ’ã€‚'
    }
  },
  3: {
    id: 3, branch: 'å¯…', name: 'å¤©æƒæ˜Ÿ', realm: REALMS.HUMAN,
    desc: 'äººé“å¤©æƒæ˜Ÿ', poem: 'æ—¶è¾°è½åœ¨å¤©æƒæ˜Ÿï¼Œæ€§æ ¼æ“æŒå¿—æ°”é›„ï¼Œä½œäº‹å·®è¿Ÿäººä¹Ÿå–œï¼Œä¸€å‘¼ç™¾å–æœ‰å¨é£Žã€‚',
    archetype: 'æŽŒæƒçš„é¢†è¢–',
    keywords: 'æƒåŠ›ã€è´£ä»»ã€ç®¡ç†ã€éœ¸é“',
    general_analysis: 'å¤©æƒæ˜Ÿä»£è¡¨äº†æžå¼ºçš„é¢†å¯¼æ°”åœºã€‚æ€§æ ¼ç¨³é‡ï¼ŒåŠžäº‹å¹²ç»ƒï¼Œå¤©ç”Ÿå–œæ¬¢æŽŒæŽ§å±€åŠ¿ã€‚',
    gender_specific: {
      male: 'ç”·å‘½å¤©æƒï¼šä¸»äº‹ä¸šå¿ƒå¼ºï¼Œæœ‰é¢†å¯¼æ¬²ï¼Œå¿…ä¸ºå•ä½ä¸€æŠŠæ‰‹æˆ–åˆ›ä¸šè€æ¿ã€‚',
      female: 'å¥³å‘½å¤©æƒï¼šå¤è¯€äº‘â€œæœ‰å¤©æƒæ˜Ÿè€…åŠ©å¤«æ—ºå­â€ã€‚èƒ½åŠ›æžå¼ºï¼Œèƒ½æ“æŒå®¶ä¸šã€‚'
    },
    advice: 'åˆ‡å¿Œåˆšæ„Žè‡ªç”¨ã€‚æƒåŠ›æ˜¯è´£ä»»çš„å¦ä¸€ç§å½¢å¼ï¼Œå­¦ä¼šæ”¾æƒã€‚',
    pos_meaning: {
      year: 'å¹´ä¸Šå¤©æƒï¼šå‡ºèº«äºŽæœ‰å¨æœ›çš„å®¶åº­ã€‚ä»Žå°æ˜¾éœ²å­©å­çŽ‹æ°”è´¨ã€‚',
      month: 'æœˆä¸Šå¤©æƒï¼šé’å¹´æ—¶æœŸåœ¨èŒåœºå´­éœ²å¤´è§’ï¼Œæ‰§è¡ŒåŠ›å¼ºï¼Œå®¹æ˜“æˆä¸ºå›¢é˜Ÿæ ¸å¿ƒã€‚',
      day: 'æ—¥ä¸Šå¤©æƒï¼šä¸­å¹´æŽŒæ¡å®žæƒï¼Œäº‹ä¸šè¾¾åˆ°é«˜å³°ã€‚åœ¨å®¶åº­ä¸­ä¹Ÿæ˜¯ä¸»å¯¼è€…ã€‚',
      hour: 'æ—¶ä¸Šå¤©æƒï¼šæ™šå¹´ä¾ç„¶ä¿æŒå¨ä¸¥ï¼Œå—äººæ•¬ç•ã€‚å­å¥³æœ‰å‡ºæ¯ã€‚'
    }
  },
  4: {
    id: 4, branch: 'å¯', name: 'å¤©ç ´æ˜Ÿ', realm: REALMS.ANIMAL,
    desc: 'ç•œé“å¤©ç ´æ˜Ÿ', poem: 'æ—¶è¾°è½åœ¨å¤©ç ´å®«ï¼Œå †é‡‘ç§¯çŽ‰ä¹Ÿæˆç©ºï¼Œå¤œçœ ç®—è®¡å›¾å®¶å¯Œï¼Œé’žè¢‹è°çŸ¥æœ‰è›€è™«ã€‚',
    archetype: 'æ…·æ…¨çš„æ•£è´¢ç«¥å­',
    keywords: 'ç ´è´¢ã€éšæ€§ã€å–„è‰¯ã€æ— è®¡åˆ’',
    general_analysis: 'å¤©ç ´æ˜Ÿä¸»è´¢æ¥è´¢åŽ»ã€‚æŒ‡å¯¹é‡‘é’±ç¼ºä¹ä¸¥è°¨çš„è§„åˆ’ï¼Œæˆ–è€…ä¸ºäººè¿‡äºŽæ…·æ…¨å¤§æ–¹ã€‚',
    gender_specific: {
      male: 'ç”·å‘½å¤©ç ´ï¼šä¸»ä»—ä¹‰ç–è´¢ï¼Œäººç¼˜å¥½ï¼Œé€‚åˆä»Žäº‹æµåŠ¨æ€§å¤§çš„è¡Œä¸šã€‚',
      female: 'å¥³å‘½å¤©ç ´ï¼šå¤è¯€äº‘â€œå¥³æ€•ç ´åˆƒåŽ„â€ã€‚éœ€é˜²å› æ„Ÿæƒ…æˆ–å®¶åº­åŽŸå› ç ´è´¢ã€‚'
    },
    advice: 'å»ºè®®å»ºç«‹å¼ºåˆ¶å‚¨è“„æœºåˆ¶ã€‚é€‚åˆæ…ˆå–„å…¬å…³è¡Œä¸šã€‚',
    pos_meaning: {
      year: 'å¹´ä¸Šå¤©ç ´ï¼šç¥–ä¸šéš¾å®ˆï¼Œæ—©å¹´å®¶å¢ƒå¯èƒ½ç»åŽ†æ³¢æŠ˜ã€‚',
      month: 'æœˆä¸Šå¤©ç ´ï¼šé’å¹´æ—¶æœŸå·¥ä½œå˜åŠ¨å¤šï¼Œé’±è´¢æ¥å¾—å¿«åŽ»å¾—ä¹Ÿå¿«ã€‚',
      day: 'æ—¥ä¸Šå¤©ç ´ï¼šä¸­å¹´éœ€é˜²æŠ•èµ„å¤±åˆ©ã€‚é…å¶å¯èƒ½ä¹Ÿä¸å–„ç†è´¢ã€‚',
      hour: 'æ—¶ä¸Šå¤©ç ´ï¼šæ™šå¹´é’±è´¢å®¹æ˜“è€—æ•£ï¼Œæˆ–è€…åœ¨å­å¥³èº«ä¸ŠèŠ±è´¹å·¨å¤§ã€‚'
    }
  },
  5: {
    id: 5, branch: 'è¾°', name: 'å¤©å¥¸æ˜Ÿ', realm: REALMS.ASURA,
    desc: 'ä¿®ç½—å¤©å¥¸æ˜Ÿ', poem: 'å¤§å¦‚æ²§æµ·ç»†å¦‚æ¯›ï¼Œä½›å£è›‡å¿ƒä¸¤é¢åˆ€ï¼Œå¥¸ç‹¡ç‹ è°‹è—æ¯’æ€§ï¼Œæ„å¤šç¿»è¦†æœ€éš¾è°ƒã€‚',
    archetype: 'æœºæ™ºçš„è°‹å£«',
    keywords: 'èªæ…§ã€è°‹ç•¥ã€å¥½æ–—ã€æœºå˜',
    general_analysis: 'å¤©å¥¸æ˜Ÿä»£è¡¨æžè‡´çš„æ™ºåŠ›ä¸Žç­–ç•¥ã€‚éžå¸¸èªæ˜Žï¼Œå–„äºŽå¯Ÿè¨€è§‚è‰²å’Œåˆ©ç”¨è§„åˆ™ã€‚',
    gender_specific: {
      male: 'ç”·å‘½å¤©å¥¸ï¼šä¸»è¶³æ™ºå¤šè°‹ï¼Œå–„äºŽæƒæœ¯ã€‚è‹¥èµ°æ­£é“æ˜¯æžä½³çš„è°‹å£«ã€‚',
      female: 'å¥³å‘½å¤©å¥¸ï¼šä¸»å¿ƒæ€ç»†è…»æ·±æ²‰ï¼Œæžå…¶èªæ˜Žï¼Œèƒ½æŠŠæŽ§å¤æ‚å…³ç³»ã€‚'
    },
    advice: 'é€‚åˆå¾‹å¸ˆã€æŠ•èµ„ã€æˆ˜ç•¥é¡¾é—®ç­‰ã€‚åˆ‡è®°çœŸè¯šå¾…äººã€‚',
    pos_meaning: {
      year: 'å¹´ä¸Šå¤©å¥¸ï¼šå®¶æ—å…³ç³»å¤æ‚ï¼Œæˆ–å¹¼å¹´çŽ¯å¢ƒå……æ»¡ç«žäº‰ã€‚å¿ƒæ™ºæ—©ç†Ÿã€‚',
      month: 'æœˆä¸Šå¤©å¥¸ï¼šé’å¹´æ—¶æœŸè¶³æ™ºå¤šè°‹ï¼Œå–„äºŽåˆ©ç”¨è§„åˆ™ã€‚åœ¨ç«žäº‰ä¸­èƒ½è„±é¢–è€Œå‡ºã€‚',
      day: 'æ—¥ä¸Šå¤©å¥¸ï¼šä¸­å¹´åŸŽåºœé¢‡æ·±ï¼Œäº‹ä¸šä¸Šå–„ç”¨æ‰‹æ®µã€‚å©šå§»ä¸­å¯èƒ½ç¼ºä¹å¦è¯šã€‚',
      hour: 'æ—¶ä¸Šå¤©å¥¸ï¼šæ™šå¹´æ€ç»´æ•æ·ï¼Œä¸ç”˜å¯‚å¯žï¼Œå–œæ¬¢å‡ºè°‹åˆ’ç­–ã€‚'
    }
  },
  6: {
    id: 6, branch: 'å·³', name: 'å¤©æ–‡æ˜Ÿ', realm: REALMS.IMMORTAL,
    desc: 'ä»™é“å¤©æ–‡æ˜Ÿ', poem: 'å‘½é‡å¤©æ–‡ç§€æ°”æ¸…ï¼Œèªæ˜Žæ™ºæ…§æ„æƒºæƒºï¼Œç”·æ‰å¥³ç§€èº«æ¸…å‰ï¼Œæ»¡è…¹æ–‡ç« é”¦ç»£æˆã€‚',
    archetype: 'å„’é›…çš„ä¹¦ç”Ÿ',
    keywords: 'æ–‡å­¦ã€åå£°ã€æ¸…ç§€ã€å¤šæƒ…',
    general_analysis: 'å¤©æ–‡æ˜Ÿä¸»æ–‡é‡‡é£Žæµã€‚å¤–è¡¨æ¸…ç§€ï¼Œå¯¹ç¾Žå­¦ã€æ–‡å­¦æœ‰å¤©ç„¶çš„æ•æ„Ÿåº¦ã€‚',
    gender_specific: {
      male: 'ç”·å‘½å¤©æ–‡ï¼šä¸»â€œç”·æ‰â€ï¼Œæ–‡è´¨å½¬å½¬ï¼Œæœ‰ä¹¦å·æ°”ï¼Œé€‚åˆèµ°å­¦æœ¯è·¯çº¿ã€‚',
      female: 'å¥³å‘½å¤©æ–‡ï¼šä¸»â€œå¥³ç§€â€ï¼Œå¤–è²Œæ¸…ç§€ï¼Œå¿ƒçµæ‰‹å·§ï¼Œæœ‰æ–‡è‰ºç‰¹é•¿ã€‚'
    },
    advice: 'åŠ¡å¿…ä»Žäº‹åˆ›é€ æ€§æˆ–æ–‡åŒ–ä¼ æ’­ç±»å·¥ä½œã€‚æ³¨æ„å¤„ç†æ„Ÿæƒ…é—®é¢˜ã€‚',
    pos_meaning: {
      year: 'å¹´ä¸Šå¤©æ–‡ï¼šå‡ºèº«ä¹¦é¦™é—¨ç¬¬ã€‚æ—©å¹´å±•çŽ°å‡ºæžé«˜çš„å­¦ä¹ å¤©èµ‹ã€‚',
      month: 'æœˆä¸Šå¤©æ–‡ï¼šé’å¹´æ—¶æœŸæ‰åŽæ¨ªæº¢ï¼Œæ–‡ç¬”æžä½³ï¼Œå®¹æ˜“èŽ·å¾—åå£°ã€‚',
      day: 'æ—¥ä¸Šå¤©æ–‡ï¼šä¸­å¹´å„’é›…é£Žæµï¼Œä»Žäº‹æ–‡æ•™ã€åˆ›æ„å·¥ä½œå¤§å‰ã€‚',
      hour: 'æ—¶ä¸Šå¤©æ–‡ï¼šæ™šå¹´ç²¾ç¥žç”Ÿæ´»ä¸°å¯Œï¼Œè‘—ä¹¦ç«‹è¯´æˆ–å¯„æƒ…å±±æ°´ã€‚'
    }
  },
  7: {
    id: 7, branch: 'åˆ', name: 'å¤©ç¦æ˜Ÿ', realm: REALMS.BUDDHA,
    desc: 'ä½›é“å¤©ç¦æ˜Ÿ', poem: 'å‘½é€¢å¤©ç¦æ˜¯ç”Ÿæ—¶ï¼Œå®šç„¶ä»“åº“æœ‰ç›ˆä½™ï¼Œå®½æ´ªå¤§é‡æ ¹åŸºç¨³ï¼Œè´¢å¸›å…‰åŽç™¾ç¦é½ã€‚',
    archetype: 'å…¥ä¸–çš„è´µäºº',
    keywords: 'ç¦æŠ¥ã€å¯Œè¶³ã€å¸ƒæ–½ã€äº¨é€š',
    general_analysis: 'å¤©ç¦æ˜Ÿä»£è¡¨ä¸–ä¿—çš„è£åŽå¯Œè´µã€‚ä¹äºŽäº«å—ç‰©è´¨ç”Ÿæ´»ï¼Œå¹¶ä¸”é€šå¸¸è¿æ°”å¾ˆå¥½ã€‚',
    gender_specific: {
      male: 'ç”·å‘½å¤©ç¦ï¼šä¸»äº‹ä¸šäº¨é€šï¼Œè´¢å®˜åŒç¾Žï¼Œæ˜¯å®¶é‡Œçš„é¡¶æ¢æŸ±ã€‚',
      female: 'å¥³å‘½å¤©ç¦ï¼šå¤è¯€äº‘â€œå¤©ç¦é‡è€…è¡£ç¦„è‡ªç„¶â€ã€‚ä¸»æ—ºå¤«ç›Šå­ï¼Œä¸€ç”Ÿå°‘æ“åŠ³ã€‚'
    },
    advice: 'ç¦æŠ¥æ·±åŽšæ˜¯ä¼˜åŠ¿ï¼Œä½†éœ€è­¦æƒ•â€œå¯Œè´µç—…â€ã€‚æŒç»­å¸ƒæ–½ã€‚',
    pos_meaning: {
      year: 'å¹´ä¸Šå¤©ç¦ï¼šå«ç€é‡‘æ±¤åŒ™å‡ºç”Ÿï¼Œæˆ–å®¶å¢ƒæ®·å®žã€‚ä»Žå°è¡£é£Ÿæ— å¿§ã€‚',
      month: 'æœˆä¸Šå¤©ç¦ï¼šé’å¹´è¿åŠ¿é¡ºé‚ï¼Œè´µäººå¤šåŠ©ï¼Œåšä»€ä¹ˆéƒ½å®¹æ˜“æˆåŠŸã€‚',
      day: 'æ—¥ä¸Šå¤©ç¦ï¼šä¸­å¹´å¯Œè´µåŒå…¨ï¼ŒæŽŒæ¡é‡è¦èµ„æºã€‚å®¶åº­å’Œç¦ã€‚',
      hour: 'æ—¶ä¸Šå¤©ç¦ï¼šæ™šæ™¯è£åŽå¯Œè´µï¼Œå­å­™æ»¡å ‚ä¸”å­é¡ºã€‚'
    }
  },
  8: {
    id: 8, branch: 'æœª', name: 'å¤©é©¿æ˜Ÿ', realm: REALMS.GHOST,
    desc: 'é¬¼é“å¤©é©¿æ˜Ÿ', poem: 'äººé“è‹¥é€¢å¤©é©¿æ˜Ÿï¼Œæ¬ç§»ç¦»ç¥–ä¸æ›¾åœï¼Œèº«å¿ƒä¸å¾—ç‰‡æ—¶é™ï¼Œèµ°éå¤©æ¶¯æ˜¯æœªå®ã€‚',
    archetype: 'å¥”æ³¢çš„æ¸¸å­',
    keywords: 'å˜åŠ¨ã€åŠ³ç¢Œã€è¿œè¡Œã€ç¤¾äº¤',
    general_analysis: 'å¤©é©¿æ˜Ÿä¸»å˜åŠ¨ã€‚å†…å¿ƒæ·±å¤„æœ‰ä¸€ç§ä¸å®‰å®šæ„Ÿï¼Œå¾ˆéš¾åœ¨ä¸€ä¸ªåœ°æ–¹é•¿ä¹…åœç•™ã€‚',
    gender_specific: {
      male: 'ç”·å‘½å¤©é©¿ï¼šå¤è¯€äº‘â€œç”·æ€•å­¤é©¿å‡¶â€ã€‚ä¸»ç»ˆèº«å¥”æ³¢ï¼Œéš¾ä»¥å®‰å®¶ã€‚',
      female: 'å¥³å‘½å¤©é©¿ï¼šå¤è¯€äº‘â€œäºŒé©¿æ˜Ÿåä¸»å¥³è´µâ€ã€‚ä¸»è§å¤šè¯†å¹¿ï¼Œèƒ½åœ¨åŠ¨ä¸­æ±‚è´¢ã€‚'
    },
    advice: 'é€‚åˆå¤–è´¸ã€æ—…æ¸¸ã€ç‰©æµç­‰å·¥ä½œã€‚ä¸è¦å¼ºæ±‚å®‰ç¨³ã€‚',
    pos_meaning: {
      year: 'å¹´ä¸Šå¤©é©¿ï¼šç¥–è¾ˆå¯èƒ½æ¼‚æ³Šä¸å®šï¼Œæˆ–è€…æ—©å¹´éšçˆ¶æ¯é¢‘ç¹æ¬å®¶ã€‚',
      month: 'æœˆä¸Šå¤©é©¿ï¼šé’å¹´æ—¶æœŸæ³¨å®šç¦»å®¶å‘å±•ï¼Œåœ¨å¤–æ±‚å­¦æˆ–å·¥ä½œã€‚',
      day: 'æ—¥ä¸Šå¤©é©¿ï¼šä¸­å¹´å¥”æ³¢åŠ³ç¢Œï¼Œå¸¸ä¸ºäº‹ä¸šå››å¤„å¥”èµ°ã€‚',
      hour: 'æ—¶ä¸Šå¤©é©¿ï¼šæ™šå¹´ä¾ç„¶é—²ä¸ä¸‹æ¥ï¼Œå–œæ¬¢æ—…æ¸¸æˆ–ç§»å±…æµ·å¤–ã€‚'
    }
  },
  9: {
    id: 9, branch: 'ç”³', name: 'å¤©å­¤æ˜Ÿ', realm: REALMS.HUMAN,
    desc: 'äººé“å¤©å­¤æ˜Ÿ', poem: 'æ—¶è¾°è‹¥é€¢æ­¤å¤©å­¤ï¼Œå…­äº²å…„å¼Ÿæœ‰å¦‚æ— ï¼Œç©ºä½œç©ºé—¨æ¸…é™å®¢ï¼Œæ€»æœ‰å¦»å„¿æƒ…åˆ†ç–ã€‚',
    archetype: 'å­¤ç‹¬çš„ä¿®è¡Œè€…',
    keywords: 'ç‹¬ç«‹ã€ç¼˜è–„ã€å®—æ•™ã€ç•Œé™æ„Ÿ',
    general_analysis: 'å¤©å­¤æ˜Ÿä¸»æƒ…æ„Ÿç–ç¦»ã€‚ä»Žå°å°±è§‰å¾—ä¸Žå®¶æ—æ ¼æ ¼ä¸å…¥ï¼Œæœ‰ä¸€ç§å¼ºçƒˆçš„â€œç•Œé™æ„Ÿâ€ã€‚',
    gender_specific: {
      male: 'ç”·å‘½å¤©å­¤ï¼šå¤è¯€äº‘â€œç”·äººå¾—ä¹‹å…­äº²æ— åˆ†â€ã€‚ä¸»æ€§æ ¼å­¤åƒ»ï¼Œé€‚åˆæžæŠ€æœ¯æˆ–ä¿®è¡Œã€‚',
      female: 'å¥³å‘½å¤©å­¤ï¼šå¤è¯€äº‘â€œå¥³äººå¾—ä¹‹å…‹å­å¦¨å¤«â€ã€‚è¦æ³¨æ„ç»è¥å©šå§»å’Œäº²å­å…³ç³»ã€‚'
    },
    advice: 'é€‚åˆç‹¬ç«‹æ€§å¼ºçš„å·¥ä½œã€‚ç¦»ç¥–åˆ™å‰ï¼ŒåŽ»å¤–åœ°å‘å±•å¯åŒ–è§£åˆ‘å…‹ã€‚',
    pos_meaning: {
      year: 'å¹´ä¸Šå¤©å­¤ï¼šæ—©å¹´ä¸Žçˆ¶æ¯ç¼˜åˆ†è¾ƒè–„ï¼Œæˆ–è€…æ€§æ ¼å†…å‘å­¤åƒ»ã€‚',
      month: 'æœˆä¸Šå¤©å­¤ï¼šå…„å¼Ÿå§å¦¹å°‘æˆ–å…³ç³»ä¸äº²å¯†ã€‚é’å¹´æ—¶æœŸä¹ æƒ¯ç‹¬æ¥ç‹¬å¾€ã€‚',
      day: 'æ—¥ä¸Šå¤©å­¤ï¼šä¸­å¹´å¤«å¦»ç¼˜åˆ†æ·¡è–„ï¼Œå€¾å‘äºŽç²¾ç¥žå±‚é¢çš„è¿½æ±‚ã€‚',
      hour: 'æ—¶ä¸Šå¤©å­¤ï¼šæ™šæ™¯å¯èƒ½æ¯”è¾ƒæ¸…å†·ï¼Œé€‚åˆä¿®è¡Œæˆ–ç‹¬ç«‹ç ”ç©¶ã€‚'
    }
  },
  10: {
    id: 10, branch: 'é…‰', name: 'å¤©åˆƒæ˜Ÿ', realm: REALMS.ANIMAL,
    desc: 'ç•œé“å¤©åˆƒæ˜Ÿ', poem: 'å¤©åˆƒä¸ºäººæ€§å¤§åˆšï¼Œæ˜¯éžç»ˆæ—¥è¦äº‰å¼ºï¼ŒæŒåˆ€å¼„æ–§åˆ‘å¿ƒé‡ï¼Œå¥½ä¼¼å°†å†›å…¥æˆ˜åœºã€‚',
    archetype: 'åˆšçƒˆçš„æˆ˜å°†',
    keywords: 'åˆšå¼ºã€äº‰æ–—ã€æŠ€æœ¯ã€ç›´çˆ½',
    general_analysis: 'å¤©åˆƒæ˜Ÿä»£è¡¨æ€ä¼å†³æ–­ã€‚æ€§æ ¼ç›´çˆ½ï¼Œè„¾æ°”ç«çˆ†ï¼Œåšäº‹é›·åŽ‰é£Žè¡Œã€‚',
    gender_specific: {
      male: 'ç”·å‘½å¤©åˆƒï¼šä¸»æ€§æ ¼åˆšæ¯…ï¼Œé€‚åˆä»Žå†›æˆ–åšå¤–ç§‘åŒ»ç”Ÿã€‚',
      female: 'å¥³å‘½å¤©åˆƒï¼šå¤è¯€äº‘â€œå¥³æ€•ç ´åˆƒåŽ„â€ã€‚æ€§æ ¼å¤ªåˆšå¼ºå®¹æ˜“åƒäºã€‚'
    },
    advice: 'é€‚åˆå†›è­¦ã€å¤–ç§‘ã€æœºæ¢°è¡Œä¸šã€‚ä¿®èº«å…»æ€§ï¼Œé‡äº‹ä¸‰æ€ã€‚',
    pos_meaning: {
      year: 'å¹´ä¸Šå¤©åˆƒï¼šç¥–ä¸Šå¯èƒ½ä»Žäº‹æ­¦èŒï¼Œæˆ–è€…æ—©å¹´æ€§æ ¼é¡½åŠ£å›é€†ã€‚',
      month: 'æœˆä¸Šå¤©åˆƒï¼šé’å¹´æ—¶æœŸè¡€æ°”æ–¹åˆšï¼Œè®²ä¹‰æ°”ä½†å®¹æ˜“å†²åŠ¨æƒ¹äº‹ã€‚',
      day: 'æ—¥ä¸Šå¤©åˆƒï¼šä¸­å¹´è„¾æ°”ç«çˆ†ï¼Œå¤«å¦»å¸¸æœ‰äº‰æ‰§ã€‚èº«ä½“æ˜“æœ‰æ‰‹æœ¯æˆ–å¤–ä¼¤ã€‚',
      hour: 'æ—¶ä¸Šå¤©åˆƒï¼šæ™šå¹´æ€§æ ¼å›ºæ‰§ï¼Œä¸æ˜“ç›¸å¤„ã€‚éœ€é˜²æ„å¤–ä¼¤å®³ã€‚'
    }
  },
  11: {
    id: 11, branch: 'æˆŒ', name: 'å¤©è‰ºæ˜Ÿ', realm: REALMS.ASURA,
    desc: 'ä¿®ç½—å¤©è‰ºæ˜Ÿ', poem: 'å¤©è‰ºç”Ÿäººæ€§æœ€çµï¼Œå°†å—ä½œåŒ—é€žå¤šèƒ½ï¼Œè®³ä¸ºè§çµæœºå…³å·§ï¼Œåˆ°å¤„å’ŒåŒä½œäº‹å‹¤ã€‚',
    archetype: 'æ‰§ç€çš„å·¥åŒ ',
    keywords: 'æ‰è‰ºã€æŠ€æœ¯ã€æ¸…é«˜ã€å†…å‘',
    general_analysis: 'å¤©è‰ºæ˜Ÿä¾§é‡äºŽâ€œæŠ€è‰ºâ€å¤©èµ‹ã€‚åœ¨æŸä¸€æ–¹é¢ï¼ˆå¦‚è‰ºæœ¯ã€ç¼–ç¨‹ï¼‰å¯èƒ½æœ‰æƒŠäººçš„å¤©èµ‹ã€‚',
    gender_specific: {
      male: 'ç”·å‘½å¤©è‰ºï¼šä¸»æŠ€è‰ºè¶…ç¾¤ï¼Œèƒ½é æ‰‹è‰ºåƒé¥­ï¼Œä½†å¯èƒ½ä¸å–„è¨€è¾žã€‚',
      female: 'å¥³å‘½å¤©è‰ºï¼šå¤è¯€äº‘â€œæœ‰å¤©æ–‡å¤©è‰ºæ˜Ÿè€…æ€§å·§â€ã€‚ä¸»å¿ƒçµæ‰‹å·§ï¼Œå–„å¥³çº¢æˆ–è®¾è®¡ã€‚'
    },
    advice: 'æ‹¥æœ‰ä¸€æŠ€ä¹‹é•¿æ˜¯ç«‹èº«ä¹‹æœ¬ã€‚ä¸è¦å¼ºè¿«è‡ªå·±é•¿è¢–å–„èˆžã€‚',
    pos_meaning: {
      year: 'å¹´ä¸Šå¤©è‰ºï¼šç¥–ä¸Šå¯èƒ½æ˜¯æ‰‹è‰ºäººã€‚æ—©å¹´å°±å±•çŽ°å‡ºè‰ºæœ¯å¤©èµ‹ã€‚',
      month: 'æœˆä¸Šå¤©è‰ºï¼šé’å¹´æ—¶æœŸå­¦è‰ºæœ‰æˆï¼Œå¤šæ‰å¤šè‰ºã€‚ä½†å¯èƒ½æ¯”è¾ƒæ¸…é«˜ã€‚',
      day: 'æ—¥ä¸Šå¤©è‰ºï¼šä¸­å¹´é ä¸€æŠ€ä¹‹é•¿ç«‹è¶³ç¤¾ä¼šï¼Œåœ¨ä¸“ä¸šé¢†åŸŸå…·æœ‰æƒå¨æ€§ã€‚',
      hour: 'æ—¶ä¸Šå¤©è‰ºï¼šæ™šå¹´ç”Ÿæ´»ä¸°å¯Œå¤šå½©ï¼Œæœ‰è‰ºæœ¯çˆ±å¥½ç›¸ä¼´ã€‚'
    }
  },
  12: {
    id: 12, branch: 'äº¥', name: 'å¤©å¯¿æ˜Ÿ', realm: REALMS.IMMORTAL,
    desc: 'ä»™é“å¤©å¯¿æ˜Ÿ', poem: 'å¤«å¦»ç”Ÿæ—¶å‘½æœ€é•¿ï¼Œä¸Šæ­ä¸‹æ•¬æ€§æ¸©è‰¯ï¼Œä¸€é—»åƒæ‚Ÿå¿ƒæ…ˆå–„ï¼Œå–œæ€’ä¸­é—´æœ‰ä¸»å¼ ã€‚',
    archetype: 'é•¿å¯¿çš„éšå£«',
    keywords: 'é•¿å¯¿ã€æ¸©å’Œã€æ…¢èŠ‚å¥ã€å¤§å™¨æ™šæˆ',
    general_analysis: 'å¤©å¯¿æ˜Ÿä¸»â€œæ…¢â€ä¸Žâ€œé™â€ã€‚å¿ƒæ€æžå¥½ï¼Œä¸äº‰ä¸æŠ¢ï¼Œå› æ­¤å¾€å¾€é«˜å¯¿ã€‚',
    gender_specific: {
      male: 'ç”·å‘½å¤©å¯¿ï¼šä¸»æ€§æ ¼å®½åŽšï¼Œä¸ä¸Žäººäº‰ï¼Œä¸€ç”Ÿå¹³ç¨³ï¼Œæ˜¯å…¸åž‹çš„â€œè€å¥½äººâ€ã€‚',
      female: 'å¥³å‘½å¤©å¯¿ï¼šä¸»æ…ˆæ‚²å–„è‰¯ï¼Œç›¸å¤«æ•™å­ï¼Œæ™šå¹´å°¤å…¶å®‰ä¹ã€‚'
    },
    advice: 'è™½ç„¶æœ‰ç¦ï¼Œä½†ä¸å¯è¿‡äºŽæ‡’æ•£ã€‚ä¾é è‡ªå·±çš„åŠªåŠ›èƒ½èŽ·å¾—æ›´è¸å®žçš„æˆå°±ã€‚',
    pos_meaning: {
      year: 'å¹´ä¸Šå¤©å¯¿ï¼šå®¶æ—æœ‰é•¿å¯¿åŸºå› ï¼Œé•¿è¾ˆæ…ˆç¥¥ã€‚æ—©å¹´ç”Ÿæ´»å¹³ç¨³ã€‚',
      month: 'æœˆä¸Šå¤©å¯¿ï¼šé’å¹´æ—¶æœŸå¿ƒæ€å¹³å’Œï¼Œä¸äº‰ä¸æŠ¢ã€‚å‘å±•é€Ÿåº¦è™½æ…¢ä½†ç¨³å¥ã€‚',
      day: 'æ—¥ä¸Šå¤©å¯¿ï¼šä¸­å¹´èº«ä½“å¥åº·ï¼Œå¿ƒæ€æžå¥½ã€‚æ—¥å­è¿‡å¾—èˆ’å¿ƒæƒ¬æ„ã€‚',
      hour: 'æ—¶ä¸Šå¤©å¯¿ï¼šé«˜å¯¿ä¹‹å‘½ï¼Œæ™šå¹´å®‰ä¹ç¥¥å’Œï¼Œæ™ºæ…§é€šè¾¾ã€‚'
    }
  },
};

const DAY_STARS = {
  1: 'å¤ªé˜³æ˜Ÿ', 7: 'å¤ªé˜³æ˜Ÿ', 13: 'å¤ªé˜³æ˜Ÿ', 19: 'å¤ªé˜³æ˜Ÿ', 25: 'å¤ªé˜³æ˜Ÿ',
  2: 'å¤ªé˜´æ˜Ÿ', 8: 'å¤ªé˜´æ˜Ÿ', 14: 'å¤ªé˜´æ˜Ÿ', 20: 'å¤ªé˜´æ˜Ÿ', 26: 'å¤ªé˜´æ˜Ÿ',
  3: 'å¤©æ­¦æ˜Ÿ', 9: 'å¤©æ­¦æ˜Ÿ', 15: 'å¤©æ­¦æ˜Ÿ', 21: 'å¤©æ­¦æ˜Ÿ', 27: 'å¤©æ­¦æ˜Ÿ',
  4: 'å¤©ç¦æ˜Ÿ', 10: 'å¤©ç¦æ˜Ÿ', 16: 'å¤©ç¦æ˜Ÿ', 22: 'å¤©ç¦æ˜Ÿ', 28: 'å¤©ç¦æ˜Ÿ',
  5: 'å¤©çš‡æ˜Ÿ', 11: 'å¤©çš‡æ˜Ÿ', 17: 'å¤©çš‡æ˜Ÿ', 23: 'å¤©çš‡æ˜Ÿ', 29: 'å¤©çš‡æ˜Ÿ',
  6: 'å¤ªä¹™æ˜Ÿ', 12: 'å¤ªä¹™æ˜Ÿ', 18: 'å¤ªä¹™æ˜Ÿ', 24: 'å¤ªä¹™æ˜Ÿ', 30: 'å¤ªä¹™æ˜Ÿ',
};

const DAY_STAR_MEANING = {
  'å¤ªé˜³æ˜Ÿ': 'è¡£ç¦„æœ‰ä½™ï¼Œåˆé™å¹³å¹³ï¼Œæœ«é™å¤§å¥½ï¼Œç”·äº«è£åŽï¼Œå¥³æ—ºå¤«å‘ç¦ã€‚',
  'å¤ªé˜´æ˜Ÿ': 'ä¸ºäººç§€æ°”ï¼Œçˆ¶æ¯æœ‰å…‹ï¼Œå…­äº²æ— å€šï¼Œç”·ä¸»æ¸…å¥‡ï¼Œå¥³ä¸»èªæ˜Žã€‚',
  'å¤©æ­¦æ˜Ÿ': 'å¤«å¦»å’Œåˆï¼Œå­æ¯åˆ‘ä¼¤ï¼Œæœ«é™è£åŽï¼Œç¦»ç¥–æˆå®¶ä¹‹å‘½ã€‚',
  'å¤©ç¦æ˜Ÿ': 'å¤šå­¦å°‘æˆï¼Œä¸­é™æ— è´¢ï¼Œæƒ¹æ˜¯æ‹›éžï¼Œæœ«é™å¯Œè´µå¤§å‰ã€‚',
  'å¤©çš‡æ˜Ÿ': 'ä¸ºäººä¼¶ä¿ï¼Œè¡£ç¦„æœ‰ä½™ï¼Œå…„å¼Ÿæ— å€šï¼Œè´¢åˆ©æ— äºä¸­å¹³ä¹‹å‘½ã€‚',
  'å¤ªä¹™æ˜Ÿ': 'å¤šå­¦å¤šèƒ½ï¼Œæ¸…é—²é«˜è´µï¼Œåˆé™å¤§è´µï¼Œæœ«é™å¤§æ—ºè´¢ç¦„ã€‚'
};

const TIME_RANGES = {
  1: '23:00 (å‰ä¸€æ—¥) - 01:00', 2: '01:00 - 03:00', 3: '03:00 - 05:00',
  4: '05:00 - 07:00', 5: '07:00 - 09:00', 6: '09:00 - 11:00',
  7: '11:00 - 13:00', 8: '13:00 - 15:00', 9: '15:00 - 17:00',
  10: '17:00 - 19:00', 11: '19:00 - 21:00', 12: '21:00 - 23:00'
};

const ZODIAC_HARM = {
  1: { target: 8, desc: 'å­æœªç›¸å®³ï¼ˆç¾Šé¼ ç›¸é€¢ä¸€æ—¦ä¼‘ï¼‰' },
  2: { target: 7, desc: 'ä¸‘åˆç›¸å®³ï¼ˆä»Žæ¥ç™½é©¬æ€•é’ç‰›ï¼‰' },
  3: { target: 6, desc: 'å¯…å·³ç›¸å®³ï¼ˆè›‡é€¢çŒ›è™Žå¦‚åˆ€æˆªï¼‰' },
  4: { target: 5, desc: 'å¯è¾°ç›¸å®³ï¼ˆçŽ‰å…”è§é¾™äº‘é‡ŒåŽ»ï¼‰' },
  5: { target: 4, desc: 'è¾°å¯ç›¸å®³ï¼ˆçŽ‰å…”è§é¾™äº‘é‡ŒåŽ»ï¼‰' },
  6: { target: 3, desc: 'å·³å¯…ç›¸å®³ï¼ˆè›‡é€¢çŒ›è™Žå¦‚åˆ€æˆªï¼‰' },
  7: { target: 2, desc: 'åˆä¸‘ç›¸å®³ï¼ˆä»Žæ¥ç™½é©¬æ€•é’ç‰›ï¼‰' },
  8: { target: 1, desc: 'æœªå­ç›¸å®³ï¼ˆç¾Šé¼ ç›¸é€¢ä¸€æ—¦ä¼‘ï¼‰' },
  9: { target: 12, desc: 'ç”³äº¥ç›¸å®³ï¼ˆçŒªè§çŒ¿çŒ´ä¼¼ç®­æŠ•ï¼‰' },
  10: { target: 11, desc: 'é…‰æˆŒç›¸å®³ï¼ˆé‡‘é¸¡é‡çŠ¬æ³ªåŒæµï¼‰' },
  11: { target: 10, desc: 'æˆŒé…‰ç›¸å®³ï¼ˆé‡‘é¸¡é‡çŠ¬æ³ªåŒæµï¼‰' },
  12: { target: 9, desc: 'äº¥ç”³ç›¸å®³ï¼ˆçŒªè§çŒ¿çŒ´ä¼¼ç®­æŠ•ï¼‰' },
};

// --- Helper Functions ---

const getTimeSubdivision = (minutes) => {
  if (minutes < 40) return { label: 'æ—¶åˆ', desc: 'åˆç”Ÿäººï¼Œå…ˆå…‹æ¯ã€‚ä½œäº‹ä¸ƒè¿›å…«é€€ï¼Œåæˆä¹è´¥ï¼Œå…­äº²ç–æ·¡ï¼Œæœ«é™äº«ç¦ã€‚' };
  if (minutes < 80) return { label: 'æ—¶ä¸­', desc: 'ä¸­ç”Ÿäººï¼Œæ— å…‹ç ´ã€‚ä¸€ç”Ÿä½œäº‹å å¼ºï¼Œæœ‰èµ·æœ‰å€’ï¼Œæœ«åŽå¤§å…´æ—ºï¼Œç¦»ç¥–å…¥èµ˜ä¸ºå‰ã€‚' };
  return { label: 'æ—¶æœ«', desc: 'æœ«ç”Ÿäººï¼Œå…ˆå…‹çˆ¶ã€‚å…­äº²ä¸å¾—åŠ›ï¼Œä¸€ç”Ÿå‹¤è‹¦åŠ³ç¢Œï¼Œä½œäº‹æœ‰å¤´æ— å°¾ï¼Œæ™šæ™¯å¥½ã€‚' };
};

const getShi = (yearIdx, month) => {
  const yearStar = STARS[yearIdx];
  const monthStar = STARS[(yearIdx + month - 1) % 12 || 12];
  if (yearStar.realm.name === 'ä½›é“' || monthStar.realm.name === 'ä½›é“') return { name: 'ä½›æ³•è¯†', desc: 'ç”Ÿæ¥å…«å­—åˆ†æ˜Žï¼Œå¥½å­¦å¤ä»Šï¼Œå¿ƒæ€§å·§æ…§ï¼Œä¸Žä½›æœ‰ç¼˜ã€‚' };
  if (yearStar.realm.name === 'ä¿®ç½—' || monthStar.realm.name === 'ä¿®ç½—') return { name: 'æ–¹ä¸ˆè¯†', desc: 'ä¸ºäººæƒæŸ„å¨ä¸¥ï¼Œä¸çŠ¯åˆ‘å†²å¤šä¸»è´µï¼Œæœ‰å¤§ä¸ˆå¤«æ°”æ¦‚ã€‚' };
  if (yearStar.realm.name === 'äººé“' || monthStar.realm.name === 'äººé“') return { name: 'é€šå¤©è¯†', desc: 'ä¸€ç”Ÿè¡£ç¦„åšç‰¢ï¼Œæ°”è±¡äººå°Šå¤šè¿‘è´µï¼Œå¯¿å…ƒé¢‡é«˜ã€‚' };
  return { name: 'å–„çŸ¥è¯†', desc: 'ä¼—äººé’¦æ•¬ï¼Œè¡£ç¦„è‡ªç„¶ä¸°è¶³ï¼Œåˆ°å¤„æœ‰è´µäººç›¸åŠ©ã€‚' };
};

const getTimeBranchIndex = (hour) => {
  if (hour >= 23 || hour < 1) return 1;
  if (hour < 3) return 2;
  if (hour < 5) return 3;
  if (hour < 7) return 4;
  if (hour < 9) return 5;
  if (hour < 11) return 6;
  if (hour < 13) return 7;
  if (hour < 15) return 8;
  if (hour < 17) return 9;
  if (hour < 19) return 10;
  if (hour < 21) return 11;
  return 12;
};

const calculatePosition = (startPos, steps, isClockwise) => {
  let current = startPos;
  const moves = steps - 1;
  if (isClockwise) {
    current = (current + moves) % 12;
    if (current === 0) current = 12;
  } else {
    current = (current - moves) % 12;
    if (current <= 0) current += 12;
  }
  return current;
};

const getFanZhongAnalysis = (starsCount) => {
  const findings = [];
  if (starsCount[1] === 2) findings.push({ star: 'å¤©è´µ', count: 2, desc: 'ç”·å‘½ä¸¤é‡å¤©è´µè€…è´µè€Œä¸è´µï¼Œçœ‹ä¼¼ä½“é¢å®žåˆ™è™šåï¼›å¥³å‘½é‡è´µè€…ç»ˆè®¸è§è´µï¼Œæ™šè¿è¾ƒå¥½ã€‚' });
  if (starsCount[2] === 2) findings.push({ star: 'å¤©åŽ„', count: 2, desc: 'åŽ„æ˜Ÿé‡çŠ¯ï¼Œåä¸ä¸ºåŽ„ï¼Œæˆ–æœ‰å°ç–¾ä½†æ— å¤§ç¢ã€‚' });
  if (starsCount[2] >= 3) findings.push({ star: 'å¤©åŽ„', count: 3, desc: 'å¤è¯€äº‘â€œé€¢ä¸‰åŽ„è€…ä¸å”¯æ— åŽ„ï¼Œè€Œè¡£ç¦„æœ‰ä½™â€ï¼Œä¸»å› ç¥¸å¾—ç¦ï¼Œæˆ–ä»Žäº‹åŒ»ç–—/æ…ˆå–„ä¸šè€Œå‘å®¶ã€‚' });
  if (starsCount[3] === 2) findings.push({ star: 'å¤©æƒ', count: 2, desc: 'ä¸¤é‡å¤©æƒï¼Œä¸ºäººåº„é‡æ­£å¤§ï¼Œä¸æ€’è‡ªå¨ã€‚' });
  if (starsCount[3] >= 3) findings.push({ star: 'å¤©æƒ', count: 3, desc: 'ä¸‰æƒåœ¨å‘½ï¼Œå¿…ä¸»å¨æƒï¼Œé€‚åˆä»Žäº‹ç®¡ç†ã€å†›è­¦æˆ–æŽŒæ¡å®žæƒçš„å²—ä½ã€‚' });
  if (starsCount[4] === 2) findings.push({ star: 'å¤©ç ´', count: 2, desc: 'åŒç ´å…¥å‘½ï¼Œè¡£ç¦„åç¨³ï¼Œè´¢åŽ»è´¢æ¥ç»ˆæœ‰ç§¯è“„ã€‚' });
  if (starsCount[4] >= 3) findings.push({ star: 'å¤©ç ´', count: 3, desc: 'ä¸‰ç ´æ”’èšï¼Œææœ‰ç ´è´¥ä¹‹è™žï¼Œéœ€ä¸¥å®ˆé’±è´¢ï¼Œä¸å¯æŠ•æœºã€‚' });
  if (starsCount[5] === 2) findings.push({ star: 'å¤©å¥¸', count: 2, desc: 'å¥¸æ˜Ÿé‡è§ï¼Œåä¸å¥¸è€Œæ­£å¤§ï¼Œä¸ºäººæœºæ™ºä½†å®ˆåº•çº¿ã€‚' });
  if (starsCount[5] >= 3) findings.push({ star: 'å¤©å¥¸', count: 3, desc: 'ä¸‰å¥¸å…¥å‘½ï¼ŒææµäºŽç‹¡ç‹¯ï¼Œéœ€ä¿®å¿ƒå…»æ€§ï¼Œé˜²å› å°èªæ˜Žè¯¯äº‹ã€‚' });
  if (starsCount[6] >= 2) findings.push({ star: 'å¤©æ–‡', count: 2, desc: 'æ–‡æ˜Ÿé‡çŠ¯ï¼Œä¸»ç”·å¥³æƒ…æ„Ÿä¸°å¯Œï¼Œæ˜“çŠ¯æ¡ƒèŠ±ï¼Œéœ€é˜²æƒ…æ„Ÿæ³›æ»¥ã€‚' });
  if (starsCount[6] >= 3) findings.push({ star: 'å¤©æ–‡', count: 3, desc: 'ä¸‰æ–‡å…¥å‘½ï¼Œè¡£ç¦„è™½å°‘ä½†æ–‡é‡‡æ–ç„¶ï¼Œé€‚åˆçº¯ç²¹çš„å­¦è€…æˆ–è‰ºæœ¯å®¶ã€‚' });
  if (starsCount[7] === 2) findings.push({ star: 'å¤©ç¦', count: 2, desc: 'äºŒç¦æ˜Ÿè€…ï¼Œæå…‹å¦»ï¼ˆæˆ–å¤«ï¼‰è€Œå…ˆè´µï¼Œäº‹ä¸šå…ˆæˆå®¶ä¸šåŽç«‹ã€‚' });
  if (starsCount[7] >= 3) findings.push({ star: 'å¤©ç¦', count: 3, desc: 'ä¸‰ç¦æ˜Ÿè€…ï¼Œæœ‰å¯¿è€Œæ— ç¦ï¼ˆæˆ–ç¦æŠ¥å¤ªé‡åç”Ÿæ‡’æƒ°ï¼‰ï¼Œå®œå¤šå¸ƒæ–½ã€‚' });
  if (starsCount[8] === 2) findings.push({ star: 'å¤©é©¿', count: 2, desc: 'äºŒé©¿æ˜Ÿåä¸»è´µï¼ˆå°¤åˆ©å¥³å‘½ï¼‰ï¼ŒåŠ¨ä¸­æ±‚è´¢å¤§å‰ã€‚' });
  if (starsCount[8] >= 3) findings.push({ star: 'å¤©é©¿', count: 3, desc: 'ä¸‰é©¿æ˜Ÿè€…ä¸»åŠ³ç¢Œï¼Œä¸€ç”Ÿå¥”æ³¢ä¸åœï¼Œéš¾å®‰ä¸€å¤„ã€‚' });
  if (starsCount[9] === 2) findings.push({ star: 'å¤©å­¤', count: 2, desc: 'äºŒå­¤æ˜Ÿè€…ï¼Œåæœ‰å­å­™ï¼Œå¹¶ä¸å…¨å­¤ï¼Œä½†å†…å¿ƒä»æœ‰ç–ç¦»æ„Ÿã€‚' });
  if (starsCount[9] >= 3) findings.push({ star: 'å¤©å­¤', count: 3, desc: 'ä¸‰å­¤å…¥å‘½ï¼Œåˆ‘å…‹å…­äº²ï¼Œå®œæ™šå©šæˆ–çšˆä¾å®—æ•™/ä»Žäº‹ç‹¬ç«‹ç ”ç©¶ã€‚' });
  if (starsCount[10] === 2) findings.push({ star: 'å¤©åˆƒ', count: 2, desc: 'äºŒåˆƒæ˜Ÿè€…ä¸»æ…ˆå–„ï¼ˆç‰©æžå¿…åï¼‰ï¼Œå¤–åˆšå†…æŸ”ã€‚' });
  if (starsCount[10] >= 3) findings.push({ star: 'å¤©åˆƒ', count: 3, desc: 'ä¸‰åˆƒæ˜Ÿè€…ï¼Œä¹ƒè´µäººæœ‰æƒä¹‹å‘½ï¼Œä½†ä¹Ÿä¸»æ€§æƒ…åˆšçƒˆã€‚' });
  if (starsCount[11] === 2) findings.push({ star: 'å¤©è‰º', count: 2, desc: 'äºŒè‰ºæ˜Ÿè€…ï¼Œå¤šæ‰å¤šè‰ºä½†ä¹Ÿå®¹æ˜“åˆ‘ä¼¤æ‰‹è¶³æˆ–ä¼´ä¾£ã€‚' });
  if (starsCount[11] >= 3) findings.push({ star: 'å¤©è‰º', count: 3, desc: 'ä¸‰è‰ºæ˜Ÿè€…ï¼Œæè’™çž³æ˜æ„šï¼Œæˆ–è‰ºå¤šä¸åŽ‹èº«ä½†éš¾ç²¾ä¸€é—¨ã€‚' });
  if (starsCount[12] === 2) findings.push({ star: 'å¤©å¯¿', count: 2, desc: 'äºŒå¯¿æ˜Ÿè€…æ€§æ„šé²ï¼ˆå¤§æ™ºè‹¥æ„šï¼‰ï¼Œä¸ºäººåŽšé“ã€‚' });
  if (starsCount[12] >= 3) findings.push({ star: 'å¤©å¯¿', count: 3, desc: 'ä¸‰å¯¿æ˜Ÿè€…ï¼Œå‡ºå®¶è€Œé«˜å¯¿ï¼Œæˆ–åœ¨ä¸–ä¿—ä¸­é•¿å¯¿ä½†æ¸…è´«ã€‚' });
  return findings;
};

const getInteractionAnalysis = (pillars) => {
  const starIds = pillars.map(p => p.data.id);
  const has = (id) => starIds.includes(id);
  const interactions = [];

  if (has(1) && has(3)) interactions.push({ title: 'è´µæƒç›¸ä½', type: 'good', desc: 'å¤©è´µæ˜Ÿï¼ˆ1ï¼‰é€¢ å¤©æƒæ˜Ÿï¼ˆ3ï¼‰ï¼šä¹¦äº‘â€œè£æ˜Œå¯Œè´µâ€ã€‚æƒåŠ›çš„æ‰§è¡ŒåŠ›é…åˆè´µäººçš„æ ¼å±€ï¼Œä¸»äº‹ä¸šæœ‰æˆï¼Œä½é«˜æƒé‡ã€‚' });
  if (has(1) && has(7)) interactions.push({ title: 'ç¦è´µåŒå…¨', type: 'good', desc: 'å¤©è´µæ˜Ÿï¼ˆ1ï¼‰é€¢ å¤©ç¦æ˜Ÿï¼ˆ7ï¼‰ï¼šä¹¦äº‘â€œæ˜¾è£ä¹‹å‘½â€ã€‚æ¸…é«˜çš„åå£°åŠ ä¸Šä¸–ä¿—çš„ç¦æŠ¥ï¼Œä¸»ä¸€ç”Ÿè¡£é£Ÿæ— å¿§ï¼Œå—äººå°Šæ•¬ã€‚' });
  if (has(3) && has(7) && has(12)) interactions.push({ title: 'ä¸‰å‰æ‹±ç…§', type: 'good', desc: 'æƒï¼ˆ3ï¼‰ã€ç¦ï¼ˆ7ï¼‰ã€å¯¿ï¼ˆ12ï¼‰ä¸‰æ˜ŸåŒåœ¨ï¼šä¹¦äº‘â€œäººäººé’¦æ•¬â€ã€‚ä¸»å®½å®å¤§é‡ï¼Œç¦å¯¿ç»µç»µï¼Œæ˜¯éš¾å¾—çš„å¥½æ ¼å±€ã€‚' });
  if (has(6) && has(1) && has(7) && has(11)) interactions.push({ title: 'é³Œå¤´ç‹¬å ', type: 'good', desc: 'æ–‡ã€è´µã€ç¦ã€è‰ºå››æ˜Ÿèšé¦–ï¼šä¹¦äº‘â€œé³Œå¤´ç‹¬å â€ã€‚ä¸»å­¦è¯†è¿‡äººï¼Œé‡‘é˜¶çŽ‰é™›ä¹‹äººï¼Œè€ƒè¿æžä½³ã€‚' });
  if (has(6) && (has(3) || has(10))) interactions.push({ title: 'æ–‡æ­¦åŒå…¨', type: 'good', desc: 'å¤©æ–‡æ˜Ÿï¼ˆ6ï¼‰é€¢ å¤©æƒï¼ˆ3ï¼‰æˆ– å¤©åˆƒï¼ˆ10ï¼‰ï¼šä¹¦äº‘â€œæ–‡æ­¦å¤šæ‰â€ã€‚ç§€æ°”çš„æ–‡é‡‡é…åˆå¼ºç¡¬çš„æ‰‹æ®µï¼Œé€‚åˆä»Žäº‹ç®¡ç†ã€å…¬æ£€æ³•æˆ–ä¼ä¸šé«˜ç®¡ã€‚' });
  if (has(5) && has(1) && has(7)) interactions.push({ title: 'æ™ºè°‹ç”Ÿè´¢', type: 'good', desc: 'å¤©å¥¸ï¼ˆ5ï¼‰é€¢ è´µï¼ˆ1ï¼‰ç¦ï¼ˆ7ï¼‰ï¼šä¹¦äº‘â€œè´¢å¸›ä¸°ç›ˆâ€ã€‚èªæ˜Žæ‰æ™ºç”¨äºŽæ­£é€”ï¼Œèƒ½é€šè¿‡æ™ºè°‹èŽ·å¾—ä¸°åŽšè´¢å¯Œï¼Œäº¦ä¸ºä¸Šå‘½ã€‚' });
  if (has(7) && has(3) && has(10)) interactions.push({ title: 'æƒç¦ç›¸ç”Ÿ', type: 'good', desc: 'å¤©ç¦ï¼ˆ7ï¼‰é€¢ æƒï¼ˆ3ï¼‰åˆƒï¼ˆ10ï¼‰ï¼šä¹¦äº‘â€œè¡£å¸›å……è¶³â€ã€‚æœ‰æƒæœ‰åŠ¿åˆæœ‰ç¦ï¼Œä¸»ä»“åº“ç›ˆä½™ï¼Œå †é‡‘ç§¯çŽ‰ã€‚' });
  if (has(12) && (has(3) || has(7))) interactions.push({ title: 'ç¦å¯¿ç»µé•¿', type: 'good', desc: 'å¤©å¯¿ï¼ˆ12ï¼‰é€¢ æƒï¼ˆ3ï¼‰æˆ– ç¦ï¼ˆ7ï¼‰ï¼šä¹¦äº‘â€œå®½å®å¤§é‡â€ã€‚ä¸»æ€§æ ¼æ¸©è‰¯ï¼Œç¦å¯¿åŒå…¨ï¼Œä¸€ç”Ÿå®‰ç¨³ã€‚' });

  if (has(1) && (has(2) || has(10) || has(9))) interactions.push({ title: 'è´µæ˜Ÿå—æŸ', type: 'mixed', desc: 'å¤©è´µæ˜Ÿï¼ˆ1ï¼‰é€¢ åŽ„ï¼ˆ2ï¼‰/åˆƒï¼ˆ10ï¼‰/å­¤ï¼ˆ9ï¼‰ï¼šä¹¦äº‘â€œæœå ‚æŠ˜æŒ«â€ã€‚è™½æœ‰è´µæ°”ï¼Œä½†æ˜“é­å°äººå«‰å¦’æˆ–èº«ä½“æœ‰æŸï¼Œè§è´µè€Œæœªä¸ºå…¨å‰ã€‚' });
  if (has(2) && has(10)) interactions.push({ title: 'åŽ„åˆƒäº¤åŠ ', type: 'bad', desc: 'å¤©åŽ„æ˜Ÿï¼ˆ2ï¼‰é€¢ å¤©åˆƒæ˜Ÿï¼ˆ10ï¼‰ï¼šä¹¦äº‘â€œç–¾ç—…è´«ç©·â€ã€‚é¬¼é“çš„æš—ç–¾åŠ ä¸Šç•œé“çš„åˆšçƒˆï¼Œéœ€ç‰¹åˆ«æ³¨æ„èº«ä½“å¥åº·å’Œæƒ…ç»ªç®¡ç†ï¼Œé˜²æ‰‹è¶³æŸä¼¤ã€‚' });
  if (has(5) && (has(3) || has(10))) interactions.push({ title: 'å¥¸æƒæ®‹å¿', type: 'mixed', desc: 'å¤©å¥¸ï¼ˆ5ï¼‰é€¢ æƒï¼ˆ3ï¼‰æˆ– åˆƒï¼ˆ10ï¼‰ï¼šä¹¦äº‘â€œå¿…ä¸ºå¥¸æƒæ®‹å¿ä¹‹äººâ€ã€‚ä¸»å¿ƒæœºæ·±æ²‰ï¼Œæ‰‹æ®µå¼ºç¡¬ï¼Œè™½ç„¶æœ‰èƒ½åŠ›ï¼Œä½†æç¼ºå¾·è¡Œï¼Œéœ€ä¿®æ…ˆæ‚²å¿ƒã€‚' });
  if (has(11) && (has(2) || has(4))) interactions.push({ title: 'è‰ºé€”å¤šèˆ›', type: 'bad', desc: 'å¤©è‰ºæ˜Ÿï¼ˆ11ï¼‰é€¢ åŽ„ï¼ˆ2ï¼‰æˆ– ç ´ï¼ˆ4ï¼‰ï¼šä¹¦äº‘â€œè‰ºä¸¾æ— æˆâ€ã€‚è™½æœ‰æ‰è‰ºï¼Œä½†å¾€å¾€éš¾ä»¥å˜çŽ°æˆ–æ€€æ‰ä¸é‡ï¼Œå»ºè®®æ”¾ä½Žèº«æ®µï¼Œå…ˆæ±‚ç”Ÿå­˜ã€‚' });
  if (has(2) && (has(8) || has(9))) interactions.push({ title: 'æ¼‚æ³ŠåŠ³ç¢Œ', type: 'bad', desc: 'å¤©åŽ„æ˜Ÿï¼ˆ2ï¼‰é€¢ å¤©é©¿ï¼ˆ8ï¼‰/å¤©å­¤ï¼ˆ9ï¼‰ï¼šä¹¦äº‘â€œé£Žå¹æ ‘å¶æ°´ä¸Šæµ®èâ€ã€‚ä¸»ä¸€ç”Ÿå¥”æ³¢ï¼Œå¿ƒçŒ¿æ„é©¬ï¼Œéš¾å®‰ä¸€å¤„ï¼Œå®œä¿®å®šåŠ›ã€‚' });
  if (has(4) && (has(8) || has(9) || has(2))) interactions.push({ title: 'ä½œäº‹è‰°éš¾', type: 'bad', desc: 'å¤©ç ´ï¼ˆ4ï¼‰é€¢ é©¿ï¼ˆ8ï¼‰/å­¤ï¼ˆ9ï¼‰/åŽ„ï¼ˆ2ï¼‰ï¼šä¹¦äº‘â€œä½œäº‹è‰°éš¾â€ã€‚ä¸»ç¥–ä¸šè€—æ•£ï¼Œæµ®æµªä¸œè¥¿ï¼Œéœ€é˜²é‡é‡ç ´è´¥ã€‚' });
  if (has(6) && (has(2) || has(4) || has(8) || has(9))) interactions.push({ title: 'å¤šå­¦å°‘æˆ', type: 'mixed', desc: 'å¤©æ–‡ï¼ˆ6ï¼‰é€¢ åŽ„/ç ´/é©¿/å­¤ï¼šä¹¦äº‘â€œå¤šå­¦å°‘æˆâ€ã€‚è™½èªæ˜Žä¼¶ä¿ï¼Œä½†æä¸ä¸ºæ–‡å¢¨ä¹‹è¾ˆï¼Œåä¸ºäº‘æ¸¸æœ¯å£«æˆ–æ‰‹è‰ºäººã€‚' });
  if (has(10) && (has(9) || has(2) || has(4))) interactions.push({ title: 'å½¢ä½“æ®‹ç–¾', type: 'bad', desc: 'å¤©åˆƒï¼ˆ10ï¼‰é€¢ å­¤/ç ´/åŽ„ï¼šä¹¦äº‘â€œå½¢ä½“æ®‹ç–¾â€ã€‚èƒ†å¤§å¿ƒç²—ï¼Œæ˜“æ‹›ç¾ç¥¸ï¼Œéœ€ç‰¹åˆ«æ³¨æ„å®‰å…¨ã€‚' });

  return interactions;
};

const getLifeAdvice = (pillars) => {
  const dayStar = pillars[2].data;
  const monthStar = pillars[1].data;

  const counts = { BUDDHA: 0, IMMORTAL: 0, HUMAN: 0, ASURA: 0, GHOST: 0, ANIMAL: 0 };
  pillars.forEach(p => {
    Object.keys(REALMS).forEach(key => {
      if (p.data.realm.name === REALMS[key].name) counts[key]++;
    });
  });
  let maxRealm = 'HUMAN';
  let maxCount = 0;
  Object.keys(counts).forEach(key => {
    if (counts[key] > maxCount) {
      maxCount = counts[key];
      maxRealm = key;
    }
  });

  let loveAdvice = "";
  let friendAdvice = "";
  let coreAdvice = "";

  if (['å¤©è´µæ˜Ÿ', 'å¤©ç¦æ˜Ÿ', 'å¤©æ–‡æ˜Ÿ', 'å¤©å¯¿æ˜Ÿ'].includes(dayStar.name)) {
    loveAdvice = "æ‚¨çš„æ—¥æŸ±åå‰æ˜Ÿï¼ˆä½›/ä»™é“ï¼‰ï¼Œé¢„ç¤ºé…å¶å¤šä¸ºè´¤è‰¯æˆ–æœ‰ç¦ä¹‹äººã€‚å»ºè®®å¯»æ‰¾æ€§æ ¼æ¸©å’Œã€æœ‰æ–‡åŒ–åº•è•´æˆ–å®¶åº­èƒŒæ™¯è‰¯å¥½çš„ä¼´ä¾£ã€‚ç›¸å¤„ä¸­å®œä»¥å’Œä¸ºè´µï¼Œæ‚¨çš„å©šå§»å¾€å¾€æ˜¯æ‚¨åŽåŠç”Ÿå¹¸ç¦çš„åŸºçŸ³ã€‚";
  } else if (['å¤©æƒæ˜Ÿ', 'å¤©å¥¸æ˜Ÿ', 'å¤©åˆƒæ˜Ÿ'].includes(dayStar.name)) {
    loveAdvice = "æ—¥æŸ±åæƒ/åˆƒ/å¥¸ï¼ˆäºº/ä¿®ç½—/ç•œé“ï¼‰ï¼Œä¸»é…å¶æ€§æ ¼å¼ºåŠ¿æˆ–èƒ½åŠ›æžå¼ºã€‚å»ºè®®å¯»æ‰¾åŒ…å®¹æ€§å¼ºã€èƒ½ä»¥æŸ”å…‹åˆšçš„ä¼´ä¾£ï¼Œæˆ–è€…åŒæ–¹åœ¨äº‹ä¸šä¸Šå„è‡ªç‹¬ç«‹ï¼Œé¿å…å®¶åº­å†…éƒ¨çš„æƒåŠ›äº‰å¤ºã€‚";
  } else {
    loveAdvice = "æ—¥æŸ±é€¢ç ´/åŽ„/é©¿/å­¤ï¼ˆé¬¼/ç•œ/äººé“ï¼‰ï¼Œæ„Ÿæƒ…è·¯å¯èƒ½ç¨æ˜¾æ³¢æŠ˜æˆ–å†…å¿ƒå­¤ç‹¬ã€‚å»ºè®®å¯»æ‰¾æˆç†Ÿç¨³é‡ã€èƒ½ç»™æ‚¨å¸¦æ¥å®‰å…¨æ„Ÿçš„ä¼´ä¾£ã€‚é¿å…å¼‚åœ°æ‹ï¼Œå¤šæ²Ÿé€šå†…å¿ƒæ„Ÿå—ï¼Œå¹³æ·¡æ˜¯çœŸã€‚";
  }

  if (monthStar.realm.name === 'ä½›é“' || monthStar.realm.name === 'ä»™é“') {
    friendAdvice = "æœˆæŸ±å…¥æ¸…å‡€é“ï¼Œæ‚¨åœ¨äº¤å‹ä¸Šè´µç²¾ä¸è´µå¤šã€‚é€‚åˆç»“äº¤æœ‰ç²¾ç¥žè¿½æ±‚ã€å¿—åŒé“åˆçš„â€œå›å­ä¹‹äº¤â€ã€‚è¿œç¦»é…’è‚‰æœ‹å‹ï¼Œä»–ä»¬ä¼šæ¶ˆè€—æ‚¨çš„çµæ°”ã€‚";
  } else if (monthStar.realm.name === 'äººé“' || monthStar.realm.name === 'ä¿®ç½—') {
    friendAdvice = "æœˆæŸ±å…¥å…¥ä¸–é“ï¼Œæ‚¨çš„ç¤¾äº¤åœˆå­å¹¿ï¼Œäººè„‰å³é’±è„‰ã€‚é€‚åˆç»“äº¤å„è¡Œå„ä¸šçš„ç²¾è‹±ã€‚ä½†éœ€é˜²èŒƒåˆ©ç›Šä¹‹äº¤èƒŒåŽçš„ç®—è®¡ï¼Œä¿æŒä¸‰åˆ†æ¸…é†’ã€‚";
  } else {
    friendAdvice = "æœˆæŸ±å…¥åŠ³ç¢Œé“ï¼ˆé¬¼/ç•œï¼‰ï¼Œäº¤å‹éœ€è°¨æ…Žï¼Œå®¹æ˜“é‡åˆ°æ¶ˆè€—æ‚¨èƒ½é‡çš„äººã€‚å»ºè®®å¤šç»“äº¤é•¿è¾ˆæˆ–å¯¼å¸ˆåž‹çš„äººç‰©ï¼ˆè´µäººï¼‰ï¼Œå‡å°‘æ— æ•ˆç¤¾äº¤ã€‚";
  }

  switch (maxRealm) {
    case 'BUDDHA': coreAdvice = "ã€ä½›é“é‡ã€‘æ‚¨çš„æ…§æ ¹æ·±åŽšï¼Œæ ¸å¿ƒä¿®å…»åœ¨äºŽâ€œæ…ˆæ‚²ä¸Žå…¥ä¸–â€ã€‚æ‚¨å®¹æ˜“å‡ºä¸–æ¸…é«˜ï¼Œå»ºè®®å¤šå‚ä¸Žç¤¾ä¼šå…¬ç›Šï¼Œå°†æ™ºæ…§è½¬åŒ–ä¸ºé€ ç¦å¤§ä¼—çš„è¡ŒåŠ¨ï¼Œé¿å…é™·å…¥è™šæ— ä¸»ä¹‰ã€‚"; break;
    case 'IMMORTAL': coreAdvice = "ã€ä»™é“é‡ã€‘æ‚¨çš„çµæ€§æžé«˜ï¼Œæ ¸å¿ƒä¿®å…»åœ¨äºŽâ€œè½åœ°ä¸Žä¸“æ³¨â€ã€‚æ‚¨æ‰åŽæ¨ªæº¢ä½†å®¹æ˜“é£˜å¿½ä¸å®šï¼Œå»ºè®®é€‰å®šä¸€ä¸ªé¢†åŸŸæ·±è€•ï¼Œå°†çµæ„Ÿå…·è±¡åŒ–ä¸ºä½œå“ï¼Œé¿å…çœ¼é«˜æ‰‹ä½Žã€‚"; break;
    case 'HUMAN': coreAdvice = "ã€äººé“é‡ã€‘æ‚¨çš„å…¥ä¸–èƒ½åŠ›å¼ºï¼Œæ ¸å¿ƒä¿®å…»åœ¨äºŽâ€œçŸ¥è¶³ä¸Žå¹³è¡¡â€ã€‚æ‚¨å®¹æ˜“é™·å…¥ååˆ©çš„è¿½é€ä¸­æ— æ³•è‡ªæ‹”ï¼Œå»ºè®®å®šæœŸä»Žç¹å¿™ä¸­æŠ½ç¦»ï¼ŒåŸ¹å…»ä¸€ç§éžåŠŸåˆ©çš„çˆ±å¥½ï¼Œæ»‹å…»å¿ƒçµã€‚"; break;
    case 'ASURA': coreAdvice = "ã€ä¿®ç½—é“é‡ã€‘æ‚¨çš„æ–—å¿—æ—ºç››ï¼Œæ ¸å¿ƒä¿®å…»åœ¨äºŽâ€œå¿è¾±ä¸ŽæŸ”å’Œâ€ã€‚æ‚¨å¥½èƒœå¿ƒå¼ºï¼Œå®¹æ˜“æ ‘æ•Œï¼Œå»ºè®®ä¿®ç‚¼â€œé€€ä¸€æ­¥æµ·é˜”å¤©ç©ºâ€çš„æ™ºæ…§ï¼Œå­¦ä¹ ç”¨æŸ”å’Œçš„æ–¹å¼è§£å†³å†²çªã€‚"; break;
    case 'GHOST': coreAdvice = "ã€é¬¼é“é‡ã€‘æ‚¨çš„ç›´è§‰æ•é”ï¼Œæ ¸å¿ƒä¿®å…»åœ¨äºŽâ€œå¸ƒæ–½ä¸Žæ„Ÿæ©â€ã€‚æ‚¨å†…å¿ƒæ·±å¤„å¯èƒ½æœ‰åŒ®ä¹æ„Ÿæˆ–ç„¦è™‘æ„Ÿï¼Œå»ºè®®é€šè¿‡ç‰©è´¨æˆ–ç²¾ç¥žçš„å¸ƒæ–½æ¥å»ºç«‹å¯Œè¶³æ„Ÿï¼Œæ„Ÿæ©å½“ä¸‹ã€‚"; break;
    case 'ANIMAL': coreAdvice = "ã€ç•œé“é‡ã€‘æ‚¨çš„æ‰§è¡ŒåŠ›å¼ºï¼Œæ ¸å¿ƒä¿®å…»åœ¨äºŽâ€œè¯»ä¹¦ä¸Žæ˜Žç†â€ã€‚æ‚¨å¯èƒ½åšäº‹è¾ƒå†²åŠ¨æˆ–éšæ³¢é€æµï¼Œå»ºè®®å¤šè¯»åœ£è´¤ä¹¦ï¼Œæå‡è®¤çŸ¥ç»´åº¦ï¼Œå‡¡äº‹ä¸‰æ€è€ŒåŽè¡Œã€‚"; break;
    default: coreAdvice = "æ‚¨çš„å‘½ç›˜èƒ½é‡åˆ†å¸ƒå‡è¡¡ï¼Œæ ¸å¿ƒä¿®å…»åœ¨äºŽâ€œä¸­é“â€ã€‚ä¸åä¸å€šï¼Œé¡ºåŠ¿è€Œä¸ºã€‚";
  }

  return { loveAdvice, friendAdvice, coreAdvice };
};

const generateAnalysis = (pillars, gender) => {
  const counts = { BUDDHA: 0, IMMORTAL: 0, HUMAN: 0, ASURA: 0, GHOST: 0, ANIMAL: 0 };
  const starsCount = {};
  pillars.forEach(p => {
    Object.keys(REALMS).forEach(key => {
      if (p.data.realm.name === REALMS[key].name) counts[key]++;
    });
    starsCount[p.data.id] = (starsCount[p.data.id] || 0) + 1;
  });

  let overallFate = "";
  let overallAdvice = "";
  const timeStar = pillars[3].data;
  const isTimeAuspicious = ['å¤©è´µæ˜Ÿ', 'å¤©ç¦æ˜Ÿ', 'å¤©æ–‡æ˜Ÿ', 'å¤©å¯¿æ˜Ÿ'].includes(timeStar.name);

  if (isTimeAuspicious && (counts.BUDDHA + counts.IMMORTAL >= 2)) {
    overallFate = "ã€ä¸Šå“æ ¼å±€ã€‘æ‚¨çš„å‘½ç›˜æ ¹åŸºæ·±åŽšï¼Œæ™šè¿å®‰è¯¦ã€‚å››æŸ±ä¸­å‰æ˜Ÿé«˜ç…§ï¼Œä¸»ä¸€ç”Ÿè´µäººå¤šåŠ©ï¼Œé€¢å‡¶åŒ–å‰ï¼Œæ™šæ™¯ä»¤äººç¾¡æ…•ã€‚";
  } else if (counts.ASURA + counts.GHOST + counts.ANIMAL >= 3) {
    overallFate = "ã€éœ€ä¿®è¡Œçš„å‘½æ ¼ã€‘æ‚¨çš„å››æŸ±ä¸­æŒ‘æˆ˜è¾ƒå¤šï¼ˆä¿®ç½—/é¬¼/ç•œé“æ˜Ÿé‡ï¼‰ï¼Œäººç”Ÿå¯èƒ½æ³¢æŠ˜è¾ƒå¤§æˆ–å†…å¿ƒå†²çªè¾ƒå¼ºã€‚ä½†è¿™æ­£æ˜¯çµé­‚é€‰æ‹©æ¥æ­¤ç£¨ç»ƒçš„è¯¾é¢˜ã€‚";
  } else {
    overallFate = "ã€ä¸­å¹³æ ¼å±€ã€‘å‰å‡¶å‚åŠï¼Œè¿åŠ¿èµ·ä¼ã€‚è™½æœ‰æŒ‘æˆ˜ï¼Œä½†ä¹Ÿæœ‰æ•‘åº”ã€‚å…³é”®åœ¨äºŽåŽå¤©çš„é€‰æ‹©ä¸Žä¿®å…»ï¼Œåˆ‡å‹¿å¦„è‡ªè²è–„ã€‚";
  }

  if (gender === 'male') {
    if (starsCount[8] >= 1 || starsCount[9] >= 1) overallAdvice += "ã€ç”·å‘½ç‰¹åˆ«æç¤ºã€‘å¤è¯€äº‘â€œç”·æ€•å­¤é©¿å‡¶â€ã€‚æ‚¨çš„å‘½ç›˜ä¸­å‡ºçŽ°å¤©å­¤æˆ–å¤©é©¿ï¼Œæš—ç¤ºä¸€ç”Ÿå¥”æ³¢æˆ–äººé™…ç–ç¦»ï¼Œéœ€ç‰¹åˆ«æ³¨æ„ç§¯æ”’äººè„‰å’Œä¿æŒå®¶åº­ç¨³å®šã€‚";
  } else {
    if (starsCount[4] >= 1 || starsCount[10] >= 1 || starsCount[2] >= 1) overallAdvice += "ã€å¥³å‘½ç‰¹åˆ«æç¤ºã€‘å¤è¯€äº‘â€œå¥³æ€•ç ´åˆƒåŽ„â€ã€‚æ‚¨çš„å‘½ç›˜ä¸­å‡ºçŽ°å¤©ç ´ã€å¤©åˆƒæˆ–å¤©åŽ„ï¼Œéœ€æ³¨æ„èº«ä½“ä¿å…»å’Œè´¢åŠ¡è§„åˆ’ï¼Œå‡¡äº‹ä»¥æŸ”å…‹åˆšä¸ºä¸Šã€‚";
  }

  if (counts.GHOST >= 2) overallAdvice += " æ­¤å¤–ï¼Œå‘½ç›˜ä¸­â€œé¬¼é“â€æ˜Ÿè¾ƒé‡ï¼Œå†…å¿ƒæ˜“æ„ŸåŒ®ä¹ï¼Œå»ºè®®å¤šåšå…¬ç›Šã€‚";
  else if (counts.ASURA >= 2) overallAdvice += " æ­¤å¤–ï¼Œâ€œä¿®ç½—â€æ˜Ÿé‡è€…å¥½èƒœå¿ƒå¼ºï¼Œå»ºè®®ä¿®èº«å…»æ€§ã€‚";

  const fanZhongFindings = getFanZhongAnalysis(starsCount);
  const interactionFindings = getInteractionAnalysis(pillars);
  const lifeAdvice = getLifeAdvice(pillars);

  return { overallFate, overallAdvice, fanZhongFindings, interactionFindings, lifeAdvice };
};

// Calculate Score helper for Birth Guide
const calculateScore = (pillars, gender) => {
  let score = 0;
  const starCounts = {};
  const starIds = [];

  pillars.forEach(p => {
    const id = p.data.id;
    starIds.push(id);
    starCounts[id] = (starCounts[id] || 0) + 1;

    if ([1, 7, 12].includes(id)) score += 2; // Gui, Fu, Shou
    else if ([3, 6].includes(id)) score += 1.5; // Quan, Wen
    else if ([5, 8, 9].includes(id)) score -= 1; // Jian, Yi, Gu
    else if ([2, 4, 10].includes(id)) score -= 2; // E, Po, Ren
  });

  if (gender === 'male') {
    if (starCounts[8]) score -= 2; // Yi
    if (starCounts[9]) score -= 2; // Gu
  } else {
    if (starCounts[4]) score -= 2; // Po
    if (starCounts[10]) score -= 2; // Ren
    if (starCounts[2]) score -= 2; // E
  }

  if (starIds.includes(1) && starIds.includes(3)) score += 3; // Gui + Quan
  if (starIds.includes(1) && starIds.includes(7)) score += 3; // Gui + Fu
  if (starIds.includes(2) && starIds.includes(10)) score -= 5; // E + Ren (Bad)

  if (starCounts[2] >= 3) score += 5;
  if (starCounts[1] >= 2) score -= 1;

  return score;
};

// Common Pillar Calculation Function
const calculatePillarsFromDate = (dateStr, timeStr, gender) => {
  if (!window.Solar) throw new Error("Solar library not ready");
  const solarDate = new Date(dateStr);
  const lunar = window.Solar.fromDate(solarDate).getLunar();

  const lunarYearZhiIndex = lunar.getYearZhiIndex() + 1;
  const lunarMonth = Math.abs(lunar.getMonth());
  const lunarDay = lunar.getDay();

  const hourInt = parseInt(timeStr.split(':')[0], 10);
  const minuteInt = parseInt(timeStr.split(':')[1], 10);
  const timeBranchIndex = getTimeBranchIndex(hourInt);

  const isClockwise = gender === 'male';

  const yearPos = lunarYearZhiIndex;
  const monthPos = calculatePosition(yearPos, lunarMonth, isClockwise);
  const dayPos = calculatePosition(monthPos, lunarDay, isClockwise);
  const timePos = calculatePosition(dayPos, timeBranchIndex, isClockwise);

  let branchStartHour = (timeBranchIndex === 1) ? 23 : (timeBranchIndex - 2) * 2 + 1;
  let diffHours = hourInt - branchStartHour;
  if (hourInt === 0 && branchStartHour === 23) diffHours = 1;
  const minutesIntoBranch = diffHours * 60 + minuteInt;
  const timeSub = getTimeSubdivision(minutesIntoBranch);

  const pillars = [
    {
      id: 'year', title: 'å¹´æŸ±', pos: yearPos, data: STARS[yearPos],
      age: '1-15å²', specific_analysis: STARS[yearPos].pos_meaning.year
    },
    {
      id: 'month', title: 'æœˆæŸ±', pos: monthPos, data: STARS[monthPos],
      age: '16-30å²', specific_analysis: STARS[monthPos].pos_meaning.month
    },
    {
      id: 'day', title: 'æ—¥æŸ±', pos: dayPos, data: STARS[dayPos],
      age: '31-45å²', specific_analysis: STARS[dayPos].pos_meaning.day
    },
    {
      id: 'time', title: 'æ—¶æŸ±', pos: timePos, data: STARS[timePos],
      age: '46å²ä»¥åŽ', specific_analysis: STARS[timePos].pos_meaning.hour
    },
  ];

  return {
    pillars,
    lunar: {
      year: `${lunar.getYearInGanZhi()}å¹´ (${lunar.getYearShengXiao()})`,
      month: `${lunar.getMonthInChinese()}æœˆ`,
      day: `${lunar.getDayInChinese()}`,
      time: `${STARS[timeBranchIndex].branch}æ—¶`,
    },
    timeSub,
    timeBranchIndex
  };
};

// --- AI Interpretation Feature ---
// Function to call Gemini API
const generateGeminiInterpretation = async (pillars, gender, lunarDate) => {
  const apiKey = "AIzaSyAsM7weol57L4JwfUDdtp56QZr1_DDpifA"; // Injected by environment
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

  const pillarText = pillars.map((p, i) => {
    const title = ['å¹´æŸ±', 'æœˆæŸ±', 'æ—¥æŸ±', 'æ—¶æŸ±'][i] || 'æœªçŸ¥';
    return `${title}: ${p.data.name} (${p.data.realm.name} - ${p.data.realm.trait})`;
  }).join('\n');

  const genderText = gender === 'male' ? 'ç”·' : 'å¥³';

  const prompt = `
    ä½ æ˜¯ä¸€ä½ç²¾é€šã€Šè¾¾æ‘©ä¸€æŽŒç»ã€‹å’Œæ·±è°™äººæ€§çš„å‘½ç†å¤§å¸ˆã€‚
    è¯·æ ¹æ®ä»¥ä¸‹ç¼˜ä¸»çš„æŽ’ç›˜ä¿¡æ¯ï¼Œè¿›è¡Œä¸€æ¬¡æ·±åº¦ã€æ¸©æš–ä¸”å¯Œæœ‰æ´žå¯ŸåŠ›çš„è§£è¯»ã€‚
    
    ã€ç¼˜ä¸»ä¿¡æ¯ã€‘
    æ€§åˆ«ï¼š${genderText}
    å‡ºç”Ÿä¿¡æ¯ï¼š${lunarDate.year} ${lunarDate.month} ${lunarDate.day} ${lunarDate.time}
    
    ã€å››æŸ±æŽ’ç›˜ã€‘
    ${pillarText}
    
    ã€è§£è¯»è¦æ±‚ã€‘
    1. **æ€§æ ¼æ·±å±‚å‰–æž**ï¼šä¸è¦åªè§£é‡Šå•æ˜Ÿï¼Œè¦åˆ†æžå››æŸ±æ˜Ÿå®¿ä¹‹é—´çš„åŒ–å­¦ååº”ï¼ˆä¾‹å¦‚ï¼šå¹´æŸ±ä½›é“+æœˆæŸ±ä¿®ç½—æ„å‘³ç€ä»€ä¹ˆå†…å¿ƒçš„å†²çªï¼Ÿï¼‰ã€‚
    2. **ä¸€ç”Ÿè¿åŠ¿æµè½¬**ï¼šç»“åˆå¹´ï¼ˆæ ¹åŸºï¼‰ã€æœˆï¼ˆäº‹ä¸š/é’å¹´ï¼‰ã€æ—¥ï¼ˆä¸­å¹´/é…å¶ï¼‰ã€æ—¶ï¼ˆæ™šå¹´/å½’å®¿ï¼‰çš„é¡ºåºï¼Œè®²è¿°ä¸€ä¸ªè¿žè´¯çš„ç”Ÿå‘½æ•…äº‹ã€‚
    3. **å½“ä¸‹æ ¸å¿ƒè¯¾é¢˜**ï¼šæŒ‡å‡ºç¼˜ä¸»ç›®å‰å¯èƒ½é¢ä¸´çš„æœ€å¤§æŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼ˆåŸºäºŽæ˜Ÿå®¿ç‰¹æ€§ï¼‰ï¼Œå¹¶ç»™å‡ºåŒ–è§£ä¹‹é“ã€‚
    4. **å¤§å¸ˆå¯„è¯­**ï¼šç»™å‡ºä¸€å¥å……æ»¡æ™ºæ…§å’ŒåŠ›é‡çš„æ€»ç»“è¯­ã€‚
    
    è¯·ç”¨Markdownæ ¼å¼è¾“å‡ºï¼Œä¿æŒè¯­æ°”å¹³å’Œã€æ…ˆæ‚²ï¼Œæ—¢æŒ‡å‡ºé—®é¢˜ï¼Œåˆç»™å‡ºå¸Œæœ›ã€‚ä¸è¦è¿‡äºŽå®¿å‘½è®ºï¼Œè¦å¼ºè°ƒä¿®è¡Œçš„åŠ›é‡ã€‚
  `;

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }]
      })
    });

    if (!response.ok) throw new Error('API request failed');
    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
  } catch (error) {
    console.error("Gemini API Error:", error);
    return "å¤§å¸ˆæ­£åœ¨é—­å…³å‚ç¦…ï¼Œæš‚æ—¶æ— æ³•è¿žæŽ¥ï¼ˆç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åŽå†è¯•ï¼‰ã€‚";
  }
};

// --- Component ---

const OnePalmApp = () => {
  const [loading, setLoading] = useState(false);
  const [lunarLibReady, setLunarLibReady] = useState(true);

  // Mode State
  const [mode, setMode] = useState('analysis'); // 'analysis', 'guide', or 'relation'

  // Analysis State
  const [gender, setGender] = useState('male');
  const [birthDate, setBirthDate] = useState('1990-06-15');
  const [birthTime, setBirthTime] = useState('12:00');
  const [result, setResult] = useState(null);
  const [activeTab, setActiveTab] = useState('analysis');

  // Guide State
  const [guideDueDate, setGuideDueDate] = useState(new Date().toISOString().split('T')[0]);
  const [guideGender, setGuideGender] = useState('male');
  const [guideResults, setGuideResults] = useState([]);
  const [guideLoading, setGuideLoading] = useState(false);

  // Relation State (New!)
  const [relName, setRelName] = useState('å¯¹æ–¹');
  const [relGender, setRelGender] = useState('female');
  const [relDate, setRelDate] = useState('1992-08-20');
  const [relTime, setRelTime] = useState('12:00');
  const [relType, setRelType] = useState('partner'); // partner, friend, family, colleague
  const [relationResult, setRelationResult] = useState(null);

  // AI State (Main Analysis)
  const [aiAnalysis, setAiAnalysis] = useState(null);
  const [isAiLoading, setIsAiLoading] = useState(false);

  // AI State (Guide Modal)
  const [activeGuideAi, setActiveGuideAi] = useState(null); // { loading, content } or null

  // UI State - Print Handling
  const [isPrinting, setIsPrinting] = useState(false);

  // Removed useEffect for script loading as we import it directly

  const handleAiAnalysis = async () => {
    if (!result) return;
    setIsAiLoading(true);
    setActiveTab('ai'); // Switch to AI tab automatically
    const analysis = await generateGeminiInterpretation(result.pillars, result.gender, result.lunar);
    setAiAnalysis(analysis);
    setIsAiLoading(false);
  };

  const handleGuideAi = async (item) => {
    setActiveGuideAi({ loading: true, content: null });
    // Pass guide gender explicitly
    const analysis = await generateGeminiInterpretation(item.pillarObjects, guideGender, item.lunarDetail);
    setActiveGuideAi({ loading: false, content: analysis });
  };

  const handlePrint = () => {
    setIsPrinting(true);
    setTimeout(() => {
      window.print();
      setIsPrinting(false);
    }, 50);
  };

  // ... HandGrid Component
  const HandGrid = ({ activePositions, printMode = false }) => {
    const palmLayout = [
      { id: 6, label: 'å·³ ä»™' }, { id: 7, label: 'åˆ ä½›' }, { id: 8, label: 'æœª é¬¼' }, { id: 9, label: 'ç”³ äºº' },
      { id: 5, label: 'è¾° ä¿®' }, { id: null }, { id: null }, { id: 10, label: 'é…‰ ç•œ' },
      { id: 4, label: 'å¯ ç•œ' }, { id: null }, { id: null }, { id: 11, label: 'æˆŒ ä¿®' },
      { id: 3, label: 'å¯… äºº' }, { id: 2, label: 'ä¸‘ é¬¼' }, { id: 1, label: 'å­ ä½›' }, { id: 12, label: 'äº¥ ä»™' },
    ];

    const containerClasses = printMode
      ? "relative w-48 aspect-square p-2 border-[4px] border-stone-800 rounded-xl select-none mx-auto mb-4 grayscale"
      : "relative w-full h-auto min-h-[24rem] max-w-sm mx-auto p-4 bg-[#f4eebf] rounded-3xl border-[6px] border-[#e6dca3] shadow-inner select-none";

    const cellClasses = (isActive, realm) => {
      if (printMode) {
        return `relative flex flex-col items-center justify-center rounded border text-xs font-bold ${isActive ? 'border-black bg-stone-100 text-black' : 'border-stone-300 text-stone-300'}`;
      }
      return `relative flex flex-col items-center justify-center rounded-xl border-2 transition-transform duration-300 min-h-[5rem] ${isActive ? `${realm.bg} ${realm.color} ${realm.border} shadow-lg scale-105 z-10` : 'bg-white/50 border-stone-200/50 text-stone-400'}`;
    };

    return (
      <div className={containerClasses}>
        {!printMode && (
          <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
            <Hand size={240} className="text-stone-500" />
          </div>
        )}
        <div className="grid grid-cols-4 gap-2 h-full text-center">
          {palmLayout.map((cell, idx) => {
            if (!cell.id) return <div key={idx} />;
            const matches = activePositions.filter(p => p.pos === cell.id);
            const isActive = matches.length > 0;
            const star = STARS[cell.id];

            return (
              <div key={idx} className={cellClasses(isActive, star.realm)}>
                <div className={printMode ? "scale-90" : "text-sm md:text-base"}>{cell.label.split(' ')[0]}</div>
                {(!printMode || isActive) && <div className={`scale-90 opacity-80 ${printMode ? 'text-[8px]' : 'text-[10px]'}`}>{star.name}</div>}
                {isActive && (
                  <div className={`absolute -top-2 -right-1 flex flex-col items-center justify-center font-bold leading-tight z-20 ${printMode ? 'text-[8px] bg-black text-white px-1 rounded' : 'bg-red-600 text-white rounded-lg px-1.5 py-0.5 text-[10px] shadow-md ring-1 ring-white'}`}>
                    {matches.map((m, i) => (
                      <span key={i} className="block">{m.label}</span>
                    ))}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </div>
    );
  };

  const calculateDestiny = () => {
    if (!lunarLibReady || !window.Solar) {
      alert("æ ¸å¿ƒç®—æ³•åº“æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨ç­‰1-2ç§’åŽå†è¯•...");
      return;
    }

    try {
      const calcResult = calculatePillarsFromDate(birthDate, birthTime, gender);

      const shi = getShi(calcResult.pillars[0].pos, Math.abs(window.Solar.fromDate(new Date(birthDate)).getLunar().getMonth()));
      const lunarDay = window.Solar.fromDate(new Date(birthDate)).getLunar().getDay();
      const dayStarName = DAY_STARS[lunarDay];
      const dayStarDesc = DAY_STAR_MEANING[dayStarName];
      const analysis = generateAnalysis(calcResult.pillars, gender);

      setResult({
        ...calcResult,
        analysis,
        gender,
        advanced: {
          timeSub: calcResult.timeSub,
          shi,
          dayStar: { name: dayStarName, desc: dayStarDesc }
        }
      });
      setAiAnalysis(null);
      setActiveTab('analysis');
    } catch (e) {
      console.error(e);
      alert("è®¡ç®—å‡ºé”™ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ—¥æœŸã€‚");
    }
  };

  const calculateRelation = () => {
    if (!result) {
      alert("è¯·å…ˆå®Œæˆæ‚¨è‡ªå·±çš„æŽ’ç›˜åˆ†æžï¼Œå†è¿›è¡Œåˆç›˜ã€‚");
      setMode('analysis');
      return;
    }
    try {
      const targetCalc = calculatePillarsFromDate(relDate, relTime, relGender);

      // Analyze Relationship
      // 1. Year Harm (Zodiac)
      const myYearId = result.pillars[0].pos;
      const targetYearId = targetCalc.pillars[0].pos;
      const harm = ZODIAC_HARM[myYearId];
      const isHarm = harm && harm.target === targetYearId;

      // 2. Missing Star Complement
      const myStars = new Set(result.pillars.map(p => p.data.id));
      const targetStars = new Set(targetCalc.pillars.map(p => p.data.id));
      const complements = [];
      if (!myStars.has(1) && targetStars.has(1)) complements.push('å¯¹æ–¹å¸¦æœ‰ã€å¤©è´µæ˜Ÿã€‘ï¼Œå¯è¡¥æ‚¨è´µäººä¹‹æ°”');
      if (!myStars.has(3) && targetStars.has(3)) complements.push('å¯¹æ–¹å¸¦æœ‰ã€å¤©æƒæ˜Ÿã€‘ï¼Œå¯åŠ©æ‚¨äº‹ä¸šå†³ç­–');
      if (!myStars.has(7) && targetStars.has(7)) complements.push('å¯¹æ–¹å¸¦æœ‰ã€å¤©ç¦æ˜Ÿã€‘ï¼Œå¯å¢žæ‚¨ç¦æŠ¥è´¢æº');
      if (!myStars.has(6) && targetStars.has(6)) complements.push('å¯¹æ–¹å¸¦æœ‰ã€å¤©æ–‡æ˜Ÿã€‘ï¼Œå¯æ·»æ‚¨çµç§€æ™ºæ…§');

      // 3. Influence Type
      let influenceScore = 0;
      const targetCounts = { BUDDHA: 0, HUMAN: 0, GHOST: 0, ANIMAL: 0 };
      targetCalc.pillars.forEach(p => {
        if (p.data.realm.name === 'ä½›é“' || p.data.realm.name === 'ä»™é“') { influenceScore += 2; targetCounts.BUDDHA++; }
        if (p.data.realm.name === 'äººé“' || p.data.realm.name === 'ä¿®ç½—') { influenceScore += 1; targetCounts.HUMAN++; }
        if (p.data.realm.name === 'é¬¼é“') { influenceScore -= 1; targetCounts.GHOST++; }
        if (p.data.realm.name === 'ç•œé“') { influenceScore -= 1; targetCounts.ANIMAL++; }
      });

      let influenceType = "ä¸­æ€§å½±å“";
      if (targetCounts.BUDDHA >= 2) influenceType = "ç²¾ç¥žè´µäººåž‹ (æå‡æ‚¨çš„çµæ€§ä¸Žç¦æŠ¥)";
      else if (targetCounts.HUMAN >= 2) influenceType = "äº‹ä¸šåŠ©åŠ›åž‹ (åœ¨çŽ°å®žå±‚é¢æŽ¨åŠ¨æ‚¨)";
      else if (targetCounts.GHOST >= 2) influenceType = "éœ€è¦åŒ…å®¹åž‹ (å¯¹æ–¹å¯èƒ½å†…å¿ƒæ•æ„Ÿï¼Œéœ€æ‚¨å¤šæ‹…å¾…)";
      else if (targetCounts.ANIMAL >= 2) influenceType = "ç›´çŽ‡å†²åŠ¨åž‹ (å¯¹æ–¹æ‰§è¡ŒåŠ›å¼ºä½†å¯èƒ½æ¶ˆè€—æ‚¨çš„è€å¿ƒ)";

      setRelationResult({
        target: targetCalc,
        analysis: {
          isHarm,
          harmDesc: isHarm ? harm.desc : 'å¹´æŸ±ç”Ÿè‚–æ— å†²å®³ï¼ŒåŸºç¡€ç¼˜åˆ†å¹³ç¨³',
          complements,
          influenceType,
          influenceScore
        }
      });

    } catch (e) {
      console.error(e);
      alert("åˆç›˜è®¡ç®—å‡ºé”™");
    }
  };

  // --- New: Birth Guide Calculation (retained) ---
  const calculateBirthGuide = () => {
    if (!lunarLibReady || !window.Solar) return;
    setGuideLoading(true);
    setGuideResults([]);

    setTimeout(() => {
      const results = [];
      const startDate = new Date(guideDueDate);
      startDate.setDate(startDate.getDate() - 30);

      const isClockwise = guideGender === 'male';

      for (let i = 0; i <= 60; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        const solar = window.Solar.fromDate(currentDate);
        const lunar = solar.getLunar();

        const lunarYearZhiIndex = lunar.getYearZhiIndex() + 1;
        const lunarMonth = Math.abs(lunar.getMonth());
        const lunarDay = lunar.getDay();

        for (let h = 1; h <= 12; h++) {
          const timeBranchIndex = h;

          const yearPos = lunarYearZhiIndex;
          const monthPos = calculatePosition(yearPos, lunarMonth, isClockwise);
          const dayPos = calculatePosition(monthPos, lunarDay, isClockwise);
          const timePos = calculatePosition(dayPos, timeBranchIndex, isClockwise);

          const pillars = [
            { id: 'year', data: STARS[yearPos] },
            { id: 'month', data: STARS[monthPos] },
            { id: 'day', data: STARS[dayPos] },
            { id: 'time', data: STARS[timePos] }
          ];

          const score = calculateScore(pillars, guideGender);
          const timeLabel = STARS[timeBranchIndex].branch + "æ—¶";
          const timeRange = TIME_RANGES[timeBranchIndex];
          const solarStr = solar.toString();

          const starCounts = {};
          pillars.forEach(p => starCounts[p.data.id] = (starCounts[p.data.id] || 0) + 1);
          const fanZhong = Object.keys(starCounts).filter(id => starCounts[id] >= 2).map(id => STARS[id].name + "çŠ¯é‡");

          results.push({
            dateStr: solarStr,
            lunarStr: `${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()}`,
            timeLabel,
            timeRange,
            score,
            pillars: pillars.map(p => p.data.name),
            pillarObjects: pillars,
            lunarDetail: { year: lunar.getYearInGanZhi(), month: lunar.getMonthInChinese(), day: lunar.getDayInChinese(), time: timeLabel },
            keyStar: pillars[3].data.name,
            fanZhong
          });
        }
      }
      const topResults = results.sort((a, b) => b.score - a.score).slice(0, 12);
      setGuideResults(topResults);
      setGuideLoading(false);
    }, 100);
  };

  if (loading) return <div className="flex items-center justify-center h-screen bg-[#fdfbf7] text-stone-500 font-serif tracking-widest">å¤©æœºè¿ç­¹ä¸­...</div>;

  return (
    <>
      <style>{`
        .print-only { display: none; }
        @media print {
          html, body, #root { height: auto !important; overflow: visible !important; position: static !important; margin: 0 !important; padding: 0 !important; display: block !important; }
          @page { size: A4; margin: 15mm; }
          body { background: white !important; color: black !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          .no-print { display: none !important; }
          .print-only { display: block !important; width: 100% !important; height: auto !important; position: static !important; visibility: visible !important; }
          .hidden { display: block !important; }
        }
      `}</style>

      <div className="min-h-screen bg-[#fdfbf7] font-serif text-stone-800 p-6 md:p-12 no-print">
        <div className="max-w-6xl mx-auto space-y-12">

          <header className="text-center space-y-4">
            <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-stone-800 text-amber-50 shadow-xl mb-2">
              <Book size={32} />
            </div>
            <h1 className="text-4xl md:text-5xl font-bold tracking-[0.2em] text-stone-900">è¾¾æ‘©ä¸€æŽŒç»</h1>

            {/* Mode Switcher */}
            <div className="flex flex-wrap justify-center gap-4 mt-4">
              <button onClick={() => setMode('analysis')} className={`px-6 py-2 rounded-full font-bold transition-all ${mode === 'analysis' ? 'bg-stone-800 text-amber-50 shadow-lg' : 'bg-stone-200 text-stone-500 hover:bg-stone-300'}`}>æŽ’ç›˜åˆ†æž</button>
              <button onClick={() => setMode('relation')} className={`px-6 py-2 rounded-full font-bold transition-all ${mode === 'relation' ? 'bg-stone-800 text-amber-50 shadow-lg' : 'bg-stone-200 text-stone-500 hover:bg-stone-300'}`}>äººé™…åˆç›˜</button>
              <button onClick={() => setMode('guide')} className={`px-6 py-2 rounded-full font-bold transition-all ${mode === 'guide' ? 'bg-stone-800 text-amber-50 shadow-lg' : 'bg-stone-200 text-stone-500 hover:bg-stone-300'}`}>å‡ºç”Ÿæ‹©å‰</button>
              {result && (
                <button onClick={handlePrint} disabled={isPrinting} className={`px-6 py-2 rounded-full font-bold transition-all border border-stone-300 text-stone-600 flex items-center gap-2 ${isPrinting ? 'bg-stone-100 cursor-wait' : 'bg-white hover:bg-stone-100'}`} title="æ‰“å°A4æŠ¥å‘Š">
                  <Printer size={18} /> {isPrinting ? 'æ­£åœ¨è°ƒèµ·...' : 'æ‰“å°æŠ¥å‘Š'}
                </button>
              )}
            </div>
          </header>

          {mode === 'analysis' ? (
            <>
              {/* ANALYSIS MODE INPUT */}
              <div className="bg-white rounded-2xl shadow-xl border border-stone-200 overflow-hidden w-full mx-auto transform transition-all hover:shadow-2xl no-print">
                <div className="bg-stone-50 px-8 py-4 border-b border-stone-100 flex items-center gap-2">
                  <Compass className="text-amber-600" size={20} />
                  <h2 className="font-bold text-stone-700 tracking-wide">æŽ’ç›˜ä¿¡æ¯å½•å…¥</h2>
                </div>
                <div className="p-8 md:p-10">
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-12">
                    <div className="space-y-3">
                      <label className="text-xs font-bold text-stone-400 uppercase tracking-widest">å‡ºç”Ÿæ—¥æœŸ (å…¬åŽ†)</label>
                      <input type="date" value={birthDate} onChange={(e) => setBirthDate(e.target.value)} className="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl text-stone-800 outline-none focus:ring-2 focus:ring-amber-200 font-mono text-lg" />
                    </div>
                    <div className="space-y-3">
                      <label className="text-xs font-bold text-stone-400 uppercase tracking-widest">å‡ºç”Ÿæ—¶é—´</label>
                      <input type="time" value={birthTime} onChange={(e) => setBirthTime(e.target.value)} className="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl text-stone-800 outline-none focus:ring-2 focus:ring-amber-200 font-mono text-lg" />
                    </div>
                    <div className="space-y-3">
                      <label className="text-xs font-bold text-stone-400 uppercase tracking-widest">æ€§åˆ« (å†³å®šé¡ºé€†)</label>
                      <div className="flex gap-4">
                        <button onClick={() => setGender('male')} className={`flex-1 py-4 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${gender === 'male' ? 'bg-stone-800 text-amber-50 shadow-lg' : 'bg-stone-100 text-stone-400'}`}><Sun size={18} /> ç”·</button>
                        <button onClick={() => setGender('female')} className={`flex-1 py-4 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${gender === 'female' ? 'bg-stone-800 text-amber-50 shadow-lg' : 'bg-stone-100 text-stone-400'}`}><RotateCcw size={18} /> å¥³</button>
                      </div>
                    </div>
                  </div>
                  <div className="mt-10 text-center">
                    <button onClick={calculateDestiny} className="px-12 py-4 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-full shadow-lg hover:shadow-amber-200/50 transform transition-all active:scale-95 text-lg tracking-widest flex items-center gap-2 mx-auto">
                      <Sparkles size={20} /> å¼€å§‹æŽ¨æ¼”
                    </button>
                  </div>
                </div>
              </div>

              {/* ANALYSIS RESULTS */}
              {result && (
                <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 md:gap-12 animate-in fade-in slide-in-from-bottom-4 duration-700">
                  {/* Left Column */}
                  <div className="lg:col-span-5 space-y-8">
                    <div className="bg-white p-8 rounded-3xl shadow-xl border border-stone-100 text-center relative overflow-hidden">
                      <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-amber-200 via-amber-400 to-amber-200"></div>
                      <h3 className="text-xl font-bold text-stone-800 mb-6 flex items-center justify-center gap-2"><Hand size={20} className="text-amber-600" /> æŽŒä¸ŠæŽ’ç›˜</h3>
                      <HandGrid activePositions={result.pillars.map((p, i) => ({ pos: p.pos, label: ['å¹´', 'æœˆ', 'æ—¥', 'æ—¶'][i] }))} />
                      <div className="mt-6 text-sm text-stone-500 font-mono bg-stone-50 py-2 px-4 rounded-full inline-block">{result.lunar.year} Â· {result.lunar.month} Â· {result.lunar.day} Â· {result.lunar.time}</div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      {result.pillars.map((p, i) => (
                        <div key={i} className={`p-5 rounded-2xl border-2 flex flex-col items-center text-center transition-all hover:scale-105 ${p.data.realm.bg} ${p.data.realm.border}`}>
                          <span className="text-[10px] font-bold uppercase tracking-widest opacity-50 mb-1">{p.title}</span>
                          <span className={`text-3xl mb-2 ${p.data.realm.color}`}>{p.data.realm.icon}</span>
                          <span className="font-bold text-stone-900 mb-1">{p.data.name}</span>
                          <span className={`text-[10px] px-2 py-0.5 rounded-full bg-white/60 ${p.data.realm.color}`}>{p.data.realm.name}</span>
                        </div>
                      ))}
                    </div>
                    {!aiAnalysis && !isAiLoading && (
                      <button onClick={handleAiAnalysis} className="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold rounded-2xl shadow-lg hover:shadow-purple-200/50 transform transition-all active:scale-95 flex items-center justify-center gap-3">
                        <Bot size={24} /> âœ¨ AI å¤§å¸ˆæ·±åº¦è§£ç›˜
                      </button>
                    )}
                  </div>

                  {/* Right Column */}
                  <div className="lg:col-span-7">
                    <div className="bg-white rounded-3xl shadow-xl border border-stone-200 overflow-hidden min-h-[600px] flex flex-col">
                      <div className="flex border-b border-stone-100 p-2 gap-2 bg-stone-50/50 overflow-x-auto">
                        {['analysis', 'chart', 'advice', 'ai'].map((tab) => (
                          <button key={tab} onClick={() => setActiveTab(tab)} disabled={tab === 'ai' && !aiAnalysis && !isAiLoading} className={`flex-1 py-3 px-4 rounded-xl text-sm font-bold tracking-wide transition-all whitespace-nowrap ${activeTab === tab ? 'bg-white text-stone-900 shadow-md ring-1 ring-stone-200' : 'text-stone-400 hover:text-stone-600'} ${(tab === 'ai' && !aiAnalysis && !isAiLoading) ? 'opacity-50 cursor-not-allowed hidden md:block' : ''}`}>
                            <div className="flex items-center justify-center gap-2">
                              {tab === 'analysis' ? 'ç»¼åˆè¿åŠ¿' : tab === 'chart' ? 'å››æŸ±è¯¦è§£' : tab === 'advice' ? 'äººç”Ÿå»ºè®®' : 'ðŸ¤– AI å¤§å¸ˆè§£è¯»'}
                            </div>
                          </button>
                        ))}
                      </div>

                      {/* ANALYSIS TAB CONTENT */}
                      <div className="p-8 md:p-10 flex-grow bg-white">
                        {activeTab === 'analysis' && (
                          <div className="space-y-10 animate-in fade-in duration-500">
                            <div className="bg-gradient-to-br from-amber-50 to-orange-50 p-8 rounded-2xl border border-amber-100">
                              <h3 className="text-xl font-bold text-amber-900 mb-4 flex items-center gap-2"><Sparkles size={20} /> å‘½æ ¼æ€»è¯„</h3>
                              <p className="text-stone-700 leading-loose text-lg font-medium">{result.analysis.overallFate}</p>

                              <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 pt-6 border-t border-amber-200/50">
                                <div className="bg-white/60 p-3 rounded-lg border border-amber-100 shadow-sm">
                                  <div className="flex items-center gap-2 text-amber-800 font-bold text-sm mb-1"><Clock size={14} /> æ—¶åˆ†ä¸‰åˆ»</div>
                                  <div className="font-bold text-stone-800">{result.advanced.timeSub.label}</div>
                                  <div className="text-xs text-stone-500 mt-1">{result.advanced.timeSub.desc}</div>
                                </div>
                                <div className="bg-white/60 p-3 rounded-lg border border-amber-100 shadow-sm">
                                  <div className="flex items-center gap-2 text-amber-800 font-bold text-sm mb-1"><Gem size={14} /> å¹´æœˆé€¢è¯†</div>
                                  <div className="font-bold text-stone-800">{result.advanced.shi.name}</div>
                                  <div className="text-xs text-stone-500 mt-1">{result.advanced.shi.desc}</div>
                                </div>
                                <div className="bg-white/60 p-3 rounded-lg border border-amber-100 shadow-sm">
                                  <div className="flex items-center gap-2 text-amber-800 font-bold text-sm mb-1"><Calendar size={14} /> æ—¥é‡å‰å‡¶</div>
                                  <div className="font-bold text-stone-800">{result.advanced.dayStar.name}</div>
                                  <div className="text-xs text-stone-500 mt-1">{result.advanced.dayStar.desc}</div>
                                </div>
                              </div>
                              {result.analysis.overallAdvice && (
                                <div className="mt-6 pt-6 border-t border-amber-200/50 text-amber-800 text-sm leading-relaxed">
                                  <span className="font-bold bg-amber-200 text-amber-900 px-2 py-1 rounded mr-2">é‡ç‚¹æç¤º</span>{result.analysis.overallAdvice}
                                </div>
                              )}
                            </div>

                            {(result.analysis.fanZhongFindings.length > 0 || result.analysis.interactionFindings.length > 0) && (
                              <div className="bg-purple-50 p-6 rounded-2xl border border-purple-100">
                                <h3 className="text-lg font-bold text-purple-900 mb-4 flex items-center gap-2"><Star size={18} className="fill-purple-600 text-purple-600" /> å‘½ç›˜æ ¼å±€Â·ç‰¹åˆ«æ–­è¯­</h3>
                                <div className="space-y-3">
                                  {result.analysis.fanZhongFindings.map((f, i) => (
                                    <div key={`fz-${i}`} className="bg-white p-3 rounded-xl border border-purple-100 shadow-sm flex gap-3 items-start">
                                      <span className="bg-purple-100 text-purple-800 text-xs font-bold px-2 py-1 rounded shrink-0 mt-0.5">çŠ¯é‡: {f.star} x {f.count}</span>
                                      <span className="text-stone-700 text-sm leading-relaxed">{f.desc}</span>
                                    </div>
                                  ))}
                                  {result.analysis.interactionFindings.map((f, i) => (
                                    <div key={`in-${i}`} className="bg-white p-3 rounded-xl border border-purple-100 shadow-sm flex gap-3 items-start">
                                      <span className={`text-xs font-bold px-2 py-1 rounded shrink-0 mt-0.5 ${f.type === 'good' ? 'bg-emerald-100 text-emerald-800' : f.type === 'bad' ? 'bg-red-100 text-red-800' : 'bg-amber-100 text-amber-800'}`}>{f.title}</span>
                                      <span className="text-stone-700 text-sm leading-relaxed">{f.desc}</span>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}

                            <div className="space-y-6">
                              <h3 className="text-lg font-bold text-stone-800 pl-4 border-l-4 border-stone-800">äººç”Ÿæµå¹´è½¨è¿¹</h3>
                              <div className="space-y-8 relative before:absolute before:left-4 before:top-2 before:bottom-2 before:w-0.5 before:bg-stone-100">
                                {result.pillars.map((pillar, idx) => (
                                  <div key={idx} className="relative pl-12">
                                    <div className={`absolute left-[11px] top-1 w-6 h-6 rounded-full border-4 border-white shadow-sm z-10 ${pillar.data.realm.bg.replace('bg-', 'bg-')} flex items-center justify-center`}>
                                      <div className={`w-2 h-2 rounded-full ${pillar.data.realm.color.replace('text-', 'bg-')}`}></div>
                                    </div>
                                    <div>
                                      <div className="flex items-center gap-3 mb-2">
                                        <span className="text-stone-900 font-bold text-lg">{pillar.data.name}</span>
                                        <span className="text-stone-500 text-sm">({pillar.title})</span>
                                        <span className="text-stone-400 text-xs uppercase tracking-wider font-bold border border-stone-200 px-2 py-0.5 rounded-full">{pillar.age}</span>
                                      </div>
                                      <div className="bg-stone-50 p-6 rounded-2xl border border-stone-100 text-stone-600 leading-relaxed hover:bg-stone-100/50 transition-colors">
                                        <div className="flex gap-2 mb-2"><MapPin size={16} className="text-amber-600 mt-1" /><strong>å®«ä½æ–­è¯­ï¼š</strong></div>
                                        {pillar.specific_analysis}
                                      </div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          </div>
                        )}
                        {activeTab === 'chart' && (
                          <div className="space-y-8 animate-in fade-in duration-500">
                            {result.pillars.map((pillar, idx) => (
                              <div key={idx} className="group relative pl-8 pb-8 border-l border-stone-200 last:border-0 last:pb-0">
                                <div className={`absolute -left-[21px] top-0 w-10 h-10 rounded-full border-4 border-white shadow-md flex items-center justify-center ${pillar.data.realm.bg} ${pillar.data.realm.color}`}>{idx + 1}</div>
                                <div className="bg-stone-50 rounded-2xl p-6 border border-stone-100 group-hover:shadow-md transition-all group-hover:bg-white group-hover:border-stone-200">
                                  <div className="flex justify-between items-start mb-4">
                                    <div>
                                      <h4 className="text-xl font-bold text-stone-900">{pillar.data.name}</h4>
                                      <span className={`text-xs font-bold px-2 py-1 rounded mt-2 inline-block ${pillar.data.realm.bg} ${pillar.data.realm.color}`}>{pillar.data.realm.name} Â· {pillar.data.realm.trait}</span>
                                    </div>
                                    <div className="text-right"><div className="text-xs text-stone-400 uppercase tracking-widest mb-1">{pillar.title}</div><div className="text-sm font-bold text-stone-600">{pillar.data.archetype}</div></div>
                                  </div>
                                  <div className="relative pl-4 mb-4 border-l-2 border-amber-200">
                                    <p className="italic text-stone-600 font-serif leading-loose text-sm">â€œ{pillar.data.poem}â€</p>
                                  </div>
                                  <div className="space-y-4 mt-4 pt-4 border-t border-stone-100">
                                    <div className="text-sm text-stone-600 leading-relaxed">
                                      <div className="flex gap-2 mb-1 text-stone-800 font-bold items-center"><Scroll size={14} /> <span>æ˜Ÿå®¿æœ¬ä¹‰ï¼š</span></div>
                                      {pillar.data.general_analysis}
                                    </div>
                                    <div className="bg-amber-50/50 p-3 rounded-lg text-sm text-stone-600 leading-relaxed">
                                      <div className="flex gap-2 mb-1 text-amber-800 font-bold items-center"><User size={14} /> <span>æ€§åˆ«å·®å¼‚ ({result.gender === 'male' ? 'ç”·' : 'å¥³'})ï¼š</span></div>
                                      {pillar.data.gender_specific[result.gender]}
                                    </div>
                                    <div className="text-sm text-stone-600 leading-relaxed">
                                      <div className="flex gap-2 mb-1 text-stone-800 font-bold items-center"><MapPin size={14} /> <span>è½å®«è¯¦è§£ ({pillar.title.split(' ')[0]})ï¼š</span></div>
                                      {pillar.specific_analysis}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}
                        {activeTab === 'advice' && (
                          <div className="space-y-8 animate-in fade-in duration-500">
                            <div className="bg-gradient-to-br from-teal-50 to-emerald-50 p-6 rounded-2xl border border-teal-100 shadow-sm">
                              <h3 className="text-xl font-bold text-teal-900 mb-4 flex items-center gap-2"><Users size={20} /> ç»¼åˆäººç”ŸæŒ‡å—</h3>
                              <div className="space-y-4">
                                <div className="bg-white/70 p-4 rounded-xl border border-teal-100/50"><h4 className="font-bold text-teal-800 mb-2 flex items-center gap-2"><Heart size={16} /> æ‹©å¶å»ºè®®</h4><p className="text-sm text-teal-900 leading-relaxed">{result.analysis.lifeAdvice.loveAdvice}</p></div>
                                <div className="bg-white/70 p-4 rounded-xl border border-teal-100/50"><h4 className="font-bold text-teal-800 mb-2 flex items-center gap-2"><Users size={16} /> äº¤å‹ä¹‹é“</h4><p className="text-sm text-teal-900 leading-relaxed">{result.analysis.lifeAdvice.friendAdvice}</p></div>
                                <div className="bg-white/70 p-4 rounded-xl border border-teal-100/50"><h4 className="font-bold text-teal-800 mb-2 flex items-center gap-2"><Flower size={16} /> æ ¸å¿ƒä¿®å…»</h4><p className="text-sm text-teal-900 leading-relaxed">{result.analysis.lifeAdvice.coreAdvice}</p></div>
                              </div>
                            </div>
                            <div className="grid gap-6 md:grid-cols-2">
                              {result.pillars.map((pillar, idx) => (
                                <div key={idx} className="bg-white border border-stone-200 rounded-2xl p-6 shadow-sm hover:shadow-md transition-shadow">
                                  <h4 className="font-bold text-stone-800 mb-4 pb-2 border-b border-stone-100 flex items-center justify-between"><span>{pillar.data.name}</span><span className="text-xs text-stone-400 font-normal">é’ˆå¯¹{pillar.title.split(' ')[0]}</span></h4>
                                  <p className="text-sm text-stone-600 leading-loose">{pillar.data.advice}</p>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                        {activeTab === 'ai' && (
                          <div className="space-y-8 animate-in fade-in duration-500">
                            {isAiLoading ? (
                              <div className="flex flex-col items-center justify-center py-20 space-y-4 text-purple-600">
                                <div className="animate-spin"><RotateCcw size={40} /></div>
                                <p className="text-lg font-bold animate-pulse">å¤§å¸ˆæ­£åœ¨é—­å…³å‚ç¦…ï¼Œä¸ºæ‚¨æ·±åº¦æŽ¨æ¼”...</p>
                              </div>
                            ) : aiAnalysis ? (
                              <div className="bg-gradient-to-br from-purple-50 to-indigo-50 p-8 rounded-3xl border border-purple-100 shadow-inner">
                                <h3 className="text-2xl font-bold text-purple-900 mb-6 flex items-center gap-3 border-b border-purple-200 pb-4"><Bot size={32} className="text-purple-600" /> å¤§å¸ˆäº²æ‰¹ Â· æ·±åº¦å‘½ç†è§£è¯»</h3>
                                <div className="prose prose-purple max-w-none text-stone-700 leading-loose font-medium whitespace-pre-wrap">{aiAnalysis}</div>
                              </div>
                            ) : (
                              <div className="flex flex-col items-center justify-center py-20 text-stone-400"><Bot size={60} className="mb-4 opacity-20" /><p>ç‚¹å‡»å·¦ä¾§â€œAI å¤§å¸ˆæ·±åº¦è§£ç›˜â€æŒ‰é’®å¼€å§‹</p></div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </>
          ) : mode === 'relation' ? (
            // RELATION MODE
            <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-8 no-print">
              <div className="bg-white rounded-2xl shadow-xl border border-stone-200 overflow-hidden w-full mx-auto">
                <div className="bg-rose-50 px-8 py-4 border-b border-rose-100 flex items-center gap-2">
                  <UserPlus className="text-rose-600" size={20} />
                  <h2 className="font-bold text-rose-800 tracking-wide">äººé™…åˆç›˜ Â· ç¼˜åˆ†æŽ¨æ¼”</h2>
                </div>
                <div className="p-8 md:p-10">
                  {!result ? (
                    <div className="text-center text-stone-500 py-10">
                      <AlertCircle size={40} className="mx-auto mb-4 opacity-50" />
                      <p>è¯·å…ˆåœ¨â€œæŽ’ç›˜åˆ†æžâ€ä¸­è¾“å…¥æ‚¨çš„ä¿¡æ¯ï¼Œä½œä¸ºåˆç›˜çš„ä¸»ä½“ã€‚</p>
                      <button onClick={() => setMode('analysis')} className="mt-4 text-rose-600 font-bold underline">åŽ»æŽ’ç›˜</button>
                    </div>
                  ) : (
                    <>
                      <div className="bg-stone-50 p-4 rounded-xl mb-8 flex items-center gap-4 border border-stone-200">
                        <div className="bg-stone-800 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold shrink-0">æˆ‘</div>
                        <div className="text-sm text-stone-600">
                          <span className="font-bold block text-stone-800">æˆ‘çš„å››æŸ±:</span>
                          {result.pillars.map(p => p.data.name).join(' / ')}
                        </div>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="space-y-3">
                          <label className="text-xs font-bold text-stone-400 uppercase tracking-widest">å¯¹æ–¹ç§°å‘¼ / å…³ç³»</label>
                          <div className="flex gap-2">
                            <input type="text" value={relName} onChange={(e) => setRelName(e.target.value)} className="flex-1 p-4 bg-stone-50 border border-stone-200 rounded-xl text-stone-800 outline-none focus:ring-2 focus:ring-rose-200" placeholder="å¦‚ï¼šæŽå››" />
                            <select value={relType} onChange={(e) => setRelType(e.target.value)} className="p-4 bg-stone-50 border border-stone-200 rounded-xl text-stone-800 outline-none">
                              <option value="partner">ä¼´ä¾£</option>
                              <option value="colleague">äº‹ä¸šä¼™ä¼´</option>
                              <option value="friend">æœ‹å‹</option>
                              <option value="family">å®¶äºº</option>
                            </select>
                          </div>
                        </div>
                        <div className="space-y-3">
                          <label className="text-xs font-bold text-stone-400 uppercase tracking-widest">å¯¹æ–¹æ€§åˆ«</label>
                          <div className="flex gap-4">
                            <button onClick={() => setRelGender('male')} className={`flex-1 py-4 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${relGender === 'male' ? 'bg-rose-800 text-white shadow-lg' : 'bg-stone-100 text-stone-400'}`}><Sun size={18} /> ç”·</button>
                            <button onClick={() => setRelGender('female')} className={`flex-1 py-4 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${relGender === 'female' ? 'bg-rose-800 text-white shadow-lg' : 'bg-stone-100 text-stone-400'}`}><RotateCcw size={18} /> å¥³</button>
                          </div>
                        </div>
                        <div className="space-y-3">
                          <label className="text-xs font-bold text-stone-400 uppercase tracking-widest">å¯¹æ–¹ç”Ÿæ—¥</label>
                          <input type="date" value={relDate} onChange={(e) => setRelDate(e.target.value)} className="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl text-stone-800 outline-none focus:ring-2 focus:ring-rose-200 font-mono text-lg" />
                        </div>
                        <div className="space-y-3">
                          <label className="text-xs font-bold text-stone-400 uppercase tracking-widest">å¯¹æ–¹æ—¶è¾°</label>
                          <input type="time" value={relTime} onChange={(e) => setRelTime(e.target.value)} className="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl text-stone-800 outline-none focus:ring-2 focus:ring-rose-200 font-mono text-lg" />
                        </div>
                      </div>
                      <div className="mt-8 text-center">
                        <button onClick={calculateRelation} className="px-12 py-4 bg-rose-600 hover:bg-rose-700 text-white font-bold rounded-full shadow-lg hover:shadow-rose-200/50 transform transition-all active:scale-95 text-lg tracking-widest flex items-center gap-2 mx-auto">
                          <ArrowRightLeft size={20} /> å¼€å§‹åˆç›˜
                        </button>
                      </div>
                    </>
                  )}
                </div>
              </div>

              {relationResult && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                  {/* Target Chart Preview */}
                  <div className="bg-white p-6 rounded-2xl shadow-md border border-stone-100">
                    <h3 className="font-bold text-stone-800 mb-4 flex items-center gap-2 border-b border-stone-100 pb-2">
                      <User size={18} /> {relName} çš„å‘½ç›˜
                    </h3>
                    <div className="grid grid-cols-2 gap-3">
                      {relationResult.target.pillars.map((p, i) => (
                        <div key={i} className={`p-3 rounded-xl border text-center ${p.data.realm.bg} ${p.data.realm.border}`}>
                          <span className="text-[10px] opacity-50 block">{p.title}</span>
                          <span className="font-bold text-stone-800">{p.data.name}</span>
                          <span className={`text-[10px] block ${p.data.realm.color}`}>{p.data.realm.name}</span>
                        </div>
                      ))}
                    </div>
                    <div className="mt-4 text-xs text-stone-500 bg-stone-50 p-2 rounded">
                      {relationResult.target.lunar.year} {relationResult.target.lunar.month} {relationResult.target.lunar.day} {relationResult.target.lunar.time}
                    </div>
                  </div>

                  {/* Analysis Result */}
                  <div className="bg-white p-6 rounded-2xl shadow-md border border-stone-100 space-y-4">
                    <h3 className="font-bold text-rose-800 mb-4 flex items-center gap-2 border-b border-rose-100 pb-2">
                      <GitMerge size={18} /> å…³ç³»æ·±åº¦åˆ†æž
                    </h3>

                    {/* 1. Zodiac Harm */}
                    <div className={`p-4 rounded-xl flex items-start gap-3 ${relationResult.analysis.isHarm ? 'bg-red-50 text-red-800' : 'bg-emerald-50 text-emerald-800'}`}>
                      {relationResult.analysis.isHarm ? <ShieldAlert size={20} className="shrink-0 mt-0.5" /> : <ShieldCheck size={20} className="shrink-0 mt-0.5" />}
                      <div>
                        <div className="font-bold text-sm">ç”Ÿè‚–æ ¹åŸºåˆ¤å®š</div>
                        <div className="text-sm mt-1 opacity-90">{relationResult.analysis.harmDesc}</div>
                      </div>
                    </div>

                    {/* 2. Complementary Stars */}
                    {relationResult.analysis.complements.length > 0 ? (
                      <div className="bg-amber-50 p-4 rounded-xl text-amber-900">
                        <div className="font-bold text-sm flex items-center gap-2 mb-2"><Sparkles size={16} /> èƒ½é‡äº’è¡¥</div>
                        <ul className="list-disc list-inside text-sm space-y-1">
                          {relationResult.analysis.complements.map((c, i) => <li key={i}>{c}</li>)}
                        </ul>
                      </div>
                    ) : (
                      <div className="bg-stone-50 p-4 rounded-xl text-stone-500 text-sm text-center">
                        æš‚æ— æ˜¾è‘—çš„æ˜Ÿå®¿äº’è¡¥ï¼ŒåŒæ–¹èƒ½é‡è¾ƒä¸ºç‹¬ç«‹ã€‚
                      </div>
                    )}

                    {/* 3. Influence Type */}
                    <div className="bg-purple-50 p-4 rounded-xl text-purple-900">
                      <div className="font-bold text-sm mb-1">å¯¹æ–¹ç»™æ‚¨å¸¦æ¥çš„ä¸»è¦å½±å“ï¼š</div>
                      <div className="text-lg font-bold">{relationResult.analysis.influenceType}</div>
                      <div className="text-xs mt-2 opacity-70">
                        (å½±å“æŒ‡æ•°: {relationResult.analysis.influenceScore > 0 ? '+' : ''}{relationResult.analysis.influenceScore} åˆ†)
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          ) : (
            // GUIDE MODE
            <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-8 no-print">
              <div className="bg-white rounded-2xl shadow-xl border border-stone-200 overflow-hidden w-full mx-auto">
                <div className="bg-teal-50 px-8 py-4 border-b border-teal-100 flex items-center gap-2">
                  <CalendarCheck className="text-teal-600" size={20} />
                  <h2 className="font-bold text-teal-800 tracking-wide">å‡ºç”Ÿæ‹©å‰ Â· é¢„äº§æœŸè§„åˆ’</h2>
                </div>
                <div className="p-8 md:p-10">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div className="space-y-3">
                      <label className="text-xs font-bold text-stone-400 uppercase tracking-widest">é¢„äº§æœŸ / ç›®æ ‡æ—¥æœŸ</label>
                      <input type="date" value={guideDueDate} onChange={(e) => setGuideDueDate(e.target.value)} className="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl text-stone-800 outline-none focus:ring-2 focus:ring-teal-200 font-mono text-lg" />
                    </div>
                    <div className="space-y-3">
                      <label className="text-xs font-bold text-stone-400 uppercase tracking-widest">å®å®æ€§åˆ«</label>
                      <div className="flex gap-4">
                        <button onClick={() => setGuideGender('male')} className={`flex-1 py-4 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${guideGender === 'male' ? 'bg-teal-800 text-white shadow-lg' : 'bg-stone-100 text-stone-400'}`}><Sun size={18} /> ç”·å®</button>
                        <button onClick={() => setGuideGender('female')} className={`flex-1 py-4 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${guideGender === 'female' ? 'bg-teal-800 text-white shadow-lg' : 'bg-stone-100 text-stone-400'}`}><RotateCcw size={18} /> å¥³å®</button>
                      </div>
                    </div>
                  </div>
                  <div className="mt-8 text-center">
                    <button onClick={calculateBirthGuide} className="px-12 py-4 bg-teal-600 hover:bg-teal-700 text-white font-bold rounded-full shadow-lg hover:shadow-teal-200/50 transform transition-all active:scale-95 text-lg tracking-widest flex items-center gap-2 mx-auto">
                      <Filter size={20} /> ç­›é€‰å‰æ—¥å‰æ—¶
                    </button>
                  </div>
                </div>
              </div>

              {guideLoading && <div className="text-center py-12 text-stone-400 animate-pulse">æ­£åœ¨éåŽ†å¤©å¹²åœ°æ”¯ï¼Œå¯»æ‰¾ä¸Šç­‰å‘½æ ¼...</div>}

              {guideResults.length > 0 && (
                <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                  {guideResults.map((res, idx) => (
                    <div key={idx} className="bg-white p-6 rounded-2xl shadow-md border border-stone-100 hover:shadow-xl transition-all relative overflow-hidden group">
                      <div className="absolute top-0 right-0 bg-teal-500 text-white text-xs font-bold px-3 py-1 rounded-bl-xl shadow-sm">å¾—åˆ†: {res.score}</div>
                      <div className="flex items-center gap-2 mb-2 text-stone-400 text-xs font-mono">
                        <Calendar size={12} /> {res.dateStr} ({res.lunarStr})
                      </div>
                      <div className="flex flex-col gap-1 mb-4">
                        <div className="flex items-baseline gap-2">
                          <h4 className="text-2xl font-bold text-stone-800">{res.timeLabel}</h4>
                          <span className="text-xs text-teal-600 font-bold bg-teal-50 px-2 py-0.5 rounded">æ™šè¿: {res.keyStar}</span>
                        </div>
                        <div className="text-xs text-stone-500 font-mono bg-stone-50 p-1 rounded text-center">{res.timeRange}</div>
                      </div>
                      <div className="space-y-2 mb-4">
                        <div className="flex justify-between text-sm text-stone-600 border-b border-stone-50 pb-1"><span>å¹´: {res.pillars[0]}</span><span>æœˆ: {res.pillars[1]}</span></div>
                        <div className="flex justify-between text-sm text-stone-600"><span>æ—¥: {res.pillars[2]}</span><span className="font-bold text-teal-700">æ—¶: {res.pillars[3]}</span></div>
                      </div>
                      <div className="flex gap-2 mt-4 flex-wrap">
                        {res.score >= 6 && <span className="text-[10px] bg-amber-100 text-amber-800 px-2 py-1 rounded flex items-center gap-1"><ThumbsUp size={10} /> ä¸Šç­‰å‘½æ ¼</span>}
                        {res.pillars.includes('å¤©è´µæ˜Ÿ') && <span className="text-[10px] bg-stone-100 text-stone-600 px-2 py-1 rounded">å«å¤©è´µ</span>}
                        {res.pillars.includes('å¤©ç¦æ˜Ÿ') && <span className="text-[10px] bg-stone-100 text-stone-600 px-2 py-1 rounded">å«å¤©ç¦</span>}
                        {res.fanZhong && res.fanZhong.map((fz, i) => (
                          <span key={i} className="text-[10px] bg-purple-100 text-purple-800 px-2 py-1 rounded border border-purple-200">{fz}</span>
                        ))}
                      </div>

                      <div className="absolute bottom-4 right-4">
                        <button
                          onClick={() => handleGuideAi(res)}
                          className="text-[10px] bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1.5 rounded-full font-bold flex items-center gap-1 transition-colors shadow-sm"
                        >
                          <Bot size={12} /> å¤§å¸ˆè¯¦è§£
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {activeGuideAi && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-300">
                  <div className="bg-white w-full max-w-2xl max-h-[80vh] rounded-3xl shadow-2xl overflow-hidden flex flex-col relative">
                    <div className="p-6 border-b border-stone-100 flex justify-between items-center bg-gradient-to-r from-purple-50 to-white">
                      <h3 className="text-xl font-bold text-purple-900 flex items-center gap-2"><Bot size={24} /> å‘½ç†å¤§å¸ˆæ·±åº¦è§£æž</h3>
                      <button onClick={() => setActiveGuideAi(null)} className="p-2 hover:bg-stone-100 rounded-full transition-colors"><X size={20} className="text-stone-400" /></button>
                    </div>
                    <div className="p-8 overflow-y-auto custom-scrollbar flex-grow">
                      {activeGuideAi.loading ? (
                        <div className="flex flex-col items-center justify-center py-12 space-y-4 text-purple-600">
                          <div className="animate-spin"><RotateCcw size={32} /></div>
                          <p className="text-sm font-bold animate-pulse">å¤§å¸ˆæ­£åœ¨å‡ç¥žæŽ¨æ¼”æ­¤æ—¥æ ¼å±€...</p>
                        </div>
                      ) : (
                        <div className="prose prose-purple max-w-none text-stone-700 leading-loose text-sm whitespace-pre-wrap">
                          {activeGuideAi.content}
                        </div>
                      )}
                    </div>
                    <div className="p-4 bg-stone-50 border-t border-stone-100 text-center text-xs text-stone-400">
                      AIç”Ÿæˆå†…å®¹ä»…ä¾›å‚è€ƒï¼Œå‘½è¿æŽŒæ¡åœ¨è‡ªå·±æ‰‹ä¸­
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

        </div>
      </div>

      {/* --- PRINT LAYOUT (Retained from previous) --- */}
      {result && (
        <div className="print-only font-serif text-black p-0 bg-white">
          <div className="text-center border-b-2 border-black pb-4 mb-6">
            <h1 className="text-3xl font-bold mb-2">è¾¾æ‘©ä¸€æŽŒç» Â· å‘½ç†åˆ†æžæŠ¥å‘Š</h1>
            <div className="flex justify-center gap-6 text-sm">
              <span>å…¬åŽ†ï¼š{birthDate} {birthTime}</span>
              <span>å†œåŽ†ï¼š{result.lunar.year} {result.lunar.month} {result.lunar.day} {result.lunar.time}</span>
              <span>æ€§åˆ«ï¼š{gender === 'male' ? 'ç”·' : 'å¥³'}</span>
            </div>
          </div>
          <div className="flex flex-row gap-6 mb-8 border-b border-stone-300 pb-6">
            <div className="w-1/3">
              <HandGrid activePositions={result.pillars.map((p, i) => ({ pos: p.pos, label: ['å¹´', 'æœˆ', 'æ—¥', 'æ—¶'][i] }))} printMode={true} />
              <div className="grid grid-cols-2 gap-2 mt-4">
                {result.pillars.map((p, i) => (
                  <div key={i} className="border border-black p-2 text-center rounded">
                    <div className="text-[10px] font-bold">{p.title.split(' ')[0]}</div>
                    <div className="font-bold text-lg my-1">{p.data.name}</div>
                    <div className="text-[10px]">{p.data.realm.name}</div>
                  </div>
                ))}
              </div>
            </div>
            <div className="w-2/3 flex flex-col justify-center">
              <h3 className="font-bold text-lg mb-2">å‘½æ ¼æ€»è¯„</h3>
              <p className="text-sm leading-relaxed mb-4">{result.analysis.overallFate}</p>
              {result.analysis.overallAdvice && (
                <div className="bg-stone-50 border border-stone-200 p-3 rounded mb-4 text-sm">
                  <strong>é‡ç‚¹æç¤ºï¼š</strong> {result.analysis.overallAdvice}
                </div>
              )}
              <div className="grid grid-cols-3 gap-2 text-xs">
                <div className="border p-2 rounded"><strong>æ—¶åˆ†:</strong> {result.advanced.timeSub.label}</div>
                <div className="border p-2 rounded"><strong>è¯†ç¥ž:</strong> {result.advanced.shi.name}</div>
                <div className="border p-2 rounded"><strong>æ—¥æ˜Ÿ:</strong> {result.advanced.dayStar.name}</div>
              </div>
            </div>
          </div>
          <div className="mb-8 break-inside-avoid">
            <h3 className="font-bold text-lg mb-4 border-l-4 border-black pl-3">å››æŸ±è¯¦è§£</h3>
            <div className="grid grid-cols-2 gap-6">
              {result.pillars.map((p, i) => (
                <div key={i} className="break-inside-avoid border border-stone-300 rounded p-4">
                  <div className="flex justify-between items-baseline mb-2 border-b border-stone-200 pb-1">
                    <h4 className="font-bold">{p.data.name} <span className="text-xs font-normal">({p.title})</span></h4>
                    <span className="text-xs bg-stone-100 px-1 rounded">{p.data.realm.trait}</span>
                  </div>
                  <p className="text-xs italic mb-2">â€œ{p.data.poem}â€</p>
                  <p className="text-xs mb-2"><strong>æœ¬ä¹‰ï¼š</strong>{p.data.general_analysis}</p>
                  <p className="text-xs"><strong>è½å®«ï¼š</strong>{p.specific_analysis}</p>
                </div>
              ))}
            </div>
          </div>
          <div className="grid grid-cols-2 gap-6 mb-6">
            <div className="break-inside-avoid">
              <h3 className="font-bold text-lg mb-3 border-l-4 border-black pl-3">äººç”Ÿå»ºè®®</h3>
              <div className="text-sm space-y-2">
                <p><strong><Heart size={12} className="inline mr-1" />æ‹©å¶ï¼š</strong>{result.analysis.lifeAdvice.loveAdvice}</p>
                <p><strong><Users size={12} className="inline mr-1" />äº¤å‹ï¼š</strong>{result.analysis.lifeAdvice.friendAdvice}</p>
                <p><strong><Flower size={12} className="inline mr-1" />ä¿®å…»ï¼š</strong>{result.analysis.lifeAdvice.coreAdvice}</p>
              </div>
            </div>
            {(result.analysis.fanZhongFindings.length > 0 || result.analysis.interactionFindings.length > 0) && (
              <div className="break-inside-avoid">
                <h3 className="font-bold text-lg mb-3 border-l-4 border-black pl-3">ç‰¹æ®Šæ–­è¯­</h3>
                <ul className="text-xs list-disc list-inside space-y-1">
                  {result.analysis.fanZhongFindings.map((f, i) => (<li key={`fz-${i}`}>{f.desc}</li>))}
                  {result.analysis.interactionFindings.map((f, i) => (<li key={`in-${i}`}><strong>{f.title}:</strong> {f.desc}</li>))}
                </ul>
              </div>
            )}
          </div>
          <div className="text-center text-[10px] text-stone-400 mt-8 pt-4 border-t border-stone-200">
            è¾¾æ‘©ä¸€æŽŒç»æŽ’ç›˜ç³»ç»Ÿ Â· ä»…ä¾›å¨±ä¹å‚è€ƒ
          </div>
        </div>
      )}
    </>
  );
};

export default OnePalmApp;
